"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _JwtGenerator = _interopRequireDefault(require("./JwtGenerator"));

var _HashGenerator = _interopRequireDefault(require("./HashGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Right now only key/secret credentials are supported.
 * However, in time JWT will also be supported.
 * The `Credentials` object provides an abstraction to this.
 *
 * @param {string} apiKey - A Vonage API Key
 * @param {string} apiSecret - A Vonage API Secret
 * @param {string} [applicationId] - A VonageApplication ID
 * @param {string|Buffer} [privateKey] -  When a string value is passed it should
 *                        either represent the path to the private key, or the actual
 *                        private key in string format. If a Buffer is passed then
 *                        it should be the key read from the file system.
 * @param {string} [signatureSecret] - A Vonage signature Secret
 * @param {string} [signatureMethod] - A Vonage compatible request signing method
 */
class Credentials {
  constructor(apiKey, apiSecret, privateKey, applicationId, signatureSecret, signatureMethod) {
    this.apiKey = apiKey;
    this.apiSecret = apiSecret;
    this.privateKey = null;
    this.applicationId = applicationId;
    this.signatureSecret = signatureSecret;
    this.signatureMethod = signatureMethod;

    if (privateKey instanceof Buffer) {
      // it is already a buffer, use it as-is
      this.privateKey = privateKey;
    } else if (typeof privateKey === "string" && privateKey.startsWith("-----BEGIN PRIVATE KEY-----")) {
      // It's a key string. Check for \n, replace with newlines
      privateKey = privateKey.replace(/\\n/g, "\n");
      this.privateKey = Buffer.from(privateKey, "utf-8");
    } else if (privateKey !== undefined) {
      if (!_fs.default.existsSync(privateKey)) {
        throw new Error("File \"".concat(privateKey, "\" not found."));
      }

      this.privateKey = _fs.default.readFileSync(privateKey);
    }
    /** @private */


    this._jwtGenerator = new _JwtGenerator.default();
    this._hashGenerator = new _HashGenerator.default();
  }
  /**
   * Generate a Jwt using the Private Key in the Credentials.
   * By default the credentials.applicationId will be used when creating the token.
   * However, this can be overwritten.
   *
   * @param {string} [applicationId] an application ID to be used instead of the
   *                default Credentials.applicationId value.
   *
   * @returns {string} The generated JWT
   */


  generateJwt() {
    var applicationId = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.applicationId;
    var privateKey = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.privateKey;
    var claims = {
      application_id: applicationId
    };

    var token = this._jwtGenerator.generate(privateKey, claims);

    return token;
  }

  generateSignature(params) {
    var signatureSecret = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.signatureSecret;
    var signatureMethod = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.signatureMethod;
    return this._hashGenerator.generate(signatureMethod, signatureSecret, params);
  }
  /**
   * @private
   * Used for testing purposes only.
   */


  _setJwtGenerator(generator) {
    this._jwtGenerator = generator;
  }
  /**
   * @private
   * Used for testing purposes only.
   */


  _setHashGenerator(generator) {
    this._hashGenerator = generator;
  }
  /**
   * Ensures a credentials instance is used.
   *
   * Key/Secret credentials are only supported at present.
   */


  static parse(obj) {
    if (obj instanceof Credentials) {
      return obj;
    } else {
      return new Credentials(obj.apiKey, obj.apiSecret, obj.privateKey, obj.applicationId, obj.signatureSecret, obj.signatureMethod);
    }
  }

}

var _default = Credentials;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9DcmVkZW50aWFscy5qcyJdLCJuYW1lcyI6WyJDcmVkZW50aWFscyIsImNvbnN0cnVjdG9yIiwiYXBpS2V5IiwiYXBpU2VjcmV0IiwicHJpdmF0ZUtleSIsImFwcGxpY2F0aW9uSWQiLCJzaWduYXR1cmVTZWNyZXQiLCJzaWduYXR1cmVNZXRob2QiLCJCdWZmZXIiLCJzdGFydHNXaXRoIiwicmVwbGFjZSIsImZyb20iLCJ1bmRlZmluZWQiLCJmcyIsImV4aXN0c1N5bmMiLCJFcnJvciIsInJlYWRGaWxlU3luYyIsIl9qd3RHZW5lcmF0b3IiLCJKd3RHZW5lcmF0b3IiLCJfaGFzaEdlbmVyYXRvciIsIkhhc2hHZW5lcmF0b3IiLCJnZW5lcmF0ZUp3dCIsImNsYWltcyIsImFwcGxpY2F0aW9uX2lkIiwidG9rZW4iLCJnZW5lcmF0ZSIsImdlbmVyYXRlU2lnbmF0dXJlIiwicGFyYW1zIiwiX3NldEp3dEdlbmVyYXRvciIsImdlbmVyYXRvciIsIl9zZXRIYXNoR2VuZXJhdG9yIiwicGFyc2UiLCJvYmoiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSxXQUFOLENBQWtCO0FBQ2hCQyxFQUFBQSxXQUFXLENBQ1RDLE1BRFMsRUFFVEMsU0FGUyxFQUdUQyxVQUhTLEVBSVRDLGFBSlMsRUFLVEMsZUFMUyxFQU1UQyxlQU5TLEVBT1Q7QUFDQSxTQUFLTCxNQUFMLEdBQWNBLE1BQWQ7QUFDQSxTQUFLQyxTQUFMLEdBQWlCQSxTQUFqQjtBQUVBLFNBQUtDLFVBQUwsR0FBa0IsSUFBbEI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCQSxhQUFyQjtBQUVBLFNBQUtDLGVBQUwsR0FBdUJBLGVBQXZCO0FBQ0EsU0FBS0MsZUFBTCxHQUF1QkEsZUFBdkI7O0FBRUEsUUFBSUgsVUFBVSxZQUFZSSxNQUExQixFQUFrQztBQUNoQztBQUNBLFdBQUtKLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0QsS0FIRCxNQUdPLElBQ0wsT0FBT0EsVUFBUCxLQUFzQixRQUF0QixJQUNBQSxVQUFVLENBQUNLLFVBQVgsQ0FBc0IsNkJBQXRCLENBRkssRUFHTDtBQUNBO0FBQ0FMLE1BQUFBLFVBQVUsR0FBR0EsVUFBVSxDQUFDTSxPQUFYLENBQW1CLE1BQW5CLEVBQTJCLElBQTNCLENBQWI7QUFDQSxXQUFLTixVQUFMLEdBQWtCSSxNQUFNLENBQUNHLElBQVAsQ0FBWVAsVUFBWixFQUF3QixPQUF4QixDQUFsQjtBQUNELEtBUE0sTUFPQSxJQUFJQSxVQUFVLEtBQUtRLFNBQW5CLEVBQThCO0FBQ25DLFVBQUksQ0FBQ0MsWUFBR0MsVUFBSCxDQUFjVixVQUFkLENBQUwsRUFBZ0M7QUFDOUIsY0FBTSxJQUFJVyxLQUFKLGtCQUFtQlgsVUFBbkIsbUJBQU47QUFDRDs7QUFDRCxXQUFLQSxVQUFMLEdBQWtCUyxZQUFHRyxZQUFILENBQWdCWixVQUFoQixDQUFsQjtBQUNEO0FBRUQ7OztBQUNBLFNBQUthLGFBQUwsR0FBcUIsSUFBSUMscUJBQUosRUFBckI7QUFDQSxTQUFLQyxjQUFMLEdBQXNCLElBQUlDLHNCQUFKLEVBQXRCO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0VDLEVBQUFBLFdBQVcsR0FHVDtBQUFBLFFBRkFoQixhQUVBLHVFQUZnQixLQUFLQSxhQUVyQjtBQUFBLFFBREFELFVBQ0EsdUVBRGEsS0FBS0EsVUFDbEI7QUFDQSxRQUFJa0IsTUFBTSxHQUFHO0FBQ1hDLE1BQUFBLGNBQWMsRUFBRWxCO0FBREwsS0FBYjs7QUFHQSxRQUFJbUIsS0FBSyxHQUFHLEtBQUtQLGFBQUwsQ0FBbUJRLFFBQW5CLENBQTRCckIsVUFBNUIsRUFBd0NrQixNQUF4QyxDQUFaOztBQUNBLFdBQU9FLEtBQVA7QUFDRDs7QUFFREUsRUFBQUEsaUJBQWlCLENBQ2ZDLE1BRGUsRUFJZjtBQUFBLFFBRkFyQixlQUVBLHVFQUZrQixLQUFLQSxlQUV2QjtBQUFBLFFBREFDLGVBQ0EsdUVBRGtCLEtBQUtBLGVBQ3ZCO0FBQ0EsV0FBTyxLQUFLWSxjQUFMLENBQW9CTSxRQUFwQixDQUNMbEIsZUFESyxFQUVMRCxlQUZLLEVBR0xxQixNQUhLLENBQVA7QUFLRDtBQUVEO0FBQ0Y7QUFDQTtBQUNBOzs7QUFDRUMsRUFBQUEsZ0JBQWdCLENBQUNDLFNBQUQsRUFBWTtBQUMxQixTQUFLWixhQUFMLEdBQXFCWSxTQUFyQjtBQUNEO0FBRUQ7QUFDRjtBQUNBO0FBQ0E7OztBQUNFQyxFQUFBQSxpQkFBaUIsQ0FBQ0QsU0FBRCxFQUFZO0FBQzNCLFNBQUtWLGNBQUwsR0FBc0JVLFNBQXRCO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBOzs7QUFDYyxTQUFMRSxLQUFLLENBQUNDLEdBQUQsRUFBTTtBQUNoQixRQUFJQSxHQUFHLFlBQVloQyxXQUFuQixFQUFnQztBQUM5QixhQUFPZ0MsR0FBUDtBQUNELEtBRkQsTUFFTztBQUNMLGFBQU8sSUFBSWhDLFdBQUosQ0FDTGdDLEdBQUcsQ0FBQzlCLE1BREMsRUFFTDhCLEdBQUcsQ0FBQzdCLFNBRkMsRUFHTDZCLEdBQUcsQ0FBQzVCLFVBSEMsRUFJTDRCLEdBQUcsQ0FBQzNCLGFBSkMsRUFLTDJCLEdBQUcsQ0FBQzFCLGVBTEMsRUFNTDBCLEdBQUcsQ0FBQ3pCLGVBTkMsQ0FBUDtBQVFEO0FBQ0Y7O0FBM0dlOztlQThHSFAsVyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgSnd0R2VuZXJhdG9yIGZyb20gXCIuL0p3dEdlbmVyYXRvclwiO1xuaW1wb3J0IEhhc2hHZW5lcmF0b3IgZnJvbSBcIi4vSGFzaEdlbmVyYXRvclwiO1xuXG4vKipcbiAqIFJpZ2h0IG5vdyBvbmx5IGtleS9zZWNyZXQgY3JlZGVudGlhbHMgYXJlIHN1cHBvcnRlZC5cbiAqIEhvd2V2ZXIsIGluIHRpbWUgSldUIHdpbGwgYWxzbyBiZSBzdXBwb3J0ZWQuXG4gKiBUaGUgYENyZWRlbnRpYWxzYCBvYmplY3QgcHJvdmlkZXMgYW4gYWJzdHJhY3Rpb24gdG8gdGhpcy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBpS2V5IC0gQSBWb25hZ2UgQVBJIEtleVxuICogQHBhcmFtIHtzdHJpbmd9IGFwaVNlY3JldCAtIEEgVm9uYWdlIEFQSSBTZWNyZXRcbiAqIEBwYXJhbSB7c3RyaW5nfSBbYXBwbGljYXRpb25JZF0gLSBBIFZvbmFnZUFwcGxpY2F0aW9uIElEXG4gKiBAcGFyYW0ge3N0cmluZ3xCdWZmZXJ9IFtwcml2YXRlS2V5XSAtICBXaGVuIGEgc3RyaW5nIHZhbHVlIGlzIHBhc3NlZCBpdCBzaG91bGRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgZWl0aGVyIHJlcHJlc2VudCB0aGUgcGF0aCB0byB0aGUgcHJpdmF0ZSBrZXksIG9yIHRoZSBhY3R1YWxcbiAqICAgICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZSBrZXkgaW4gc3RyaW5nIGZvcm1hdC4gSWYgYSBCdWZmZXIgaXMgcGFzc2VkIHRoZW5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgaXQgc2hvdWxkIGJlIHRoZSBrZXkgcmVhZCBmcm9tIHRoZSBmaWxlIHN5c3RlbS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBbc2lnbmF0dXJlU2VjcmV0XSAtIEEgVm9uYWdlIHNpZ25hdHVyZSBTZWNyZXRcbiAqIEBwYXJhbSB7c3RyaW5nfSBbc2lnbmF0dXJlTWV0aG9kXSAtIEEgVm9uYWdlIGNvbXBhdGlibGUgcmVxdWVzdCBzaWduaW5nIG1ldGhvZFxuICovXG5jbGFzcyBDcmVkZW50aWFscyB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwaUtleSxcbiAgICBhcGlTZWNyZXQsXG4gICAgcHJpdmF0ZUtleSxcbiAgICBhcHBsaWNhdGlvbklkLFxuICAgIHNpZ25hdHVyZVNlY3JldCxcbiAgICBzaWduYXR1cmVNZXRob2RcbiAgKSB7XG4gICAgdGhpcy5hcGlLZXkgPSBhcGlLZXk7XG4gICAgdGhpcy5hcGlTZWNyZXQgPSBhcGlTZWNyZXQ7XG5cbiAgICB0aGlzLnByaXZhdGVLZXkgPSBudWxsO1xuICAgIHRoaXMuYXBwbGljYXRpb25JZCA9IGFwcGxpY2F0aW9uSWQ7XG5cbiAgICB0aGlzLnNpZ25hdHVyZVNlY3JldCA9IHNpZ25hdHVyZVNlY3JldDtcbiAgICB0aGlzLnNpZ25hdHVyZU1ldGhvZCA9IHNpZ25hdHVyZU1ldGhvZDtcblxuICAgIGlmIChwcml2YXRlS2V5IGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgICAvLyBpdCBpcyBhbHJlYWR5IGEgYnVmZmVyLCB1c2UgaXQgYXMtaXNcbiAgICAgIHRoaXMucHJpdmF0ZUtleSA9IHByaXZhdGVLZXk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHR5cGVvZiBwcml2YXRlS2V5ID09PSBcInN0cmluZ1wiICYmXG4gICAgICBwcml2YXRlS2V5LnN0YXJ0c1dpdGgoXCItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cIilcbiAgICApIHtcbiAgICAgIC8vIEl0J3MgYSBrZXkgc3RyaW5nLiBDaGVjayBmb3IgXFxuLCByZXBsYWNlIHdpdGggbmV3bGluZXNcbiAgICAgIHByaXZhdGVLZXkgPSBwcml2YXRlS2V5LnJlcGxhY2UoL1xcXFxuL2csIFwiXFxuXCIpO1xuICAgICAgdGhpcy5wcml2YXRlS2V5ID0gQnVmZmVyLmZyb20ocHJpdmF0ZUtleSwgXCJ1dGYtOFwiKTtcbiAgICB9IGVsc2UgaWYgKHByaXZhdGVLZXkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHByaXZhdGVLZXkpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZSBcIiR7cHJpdmF0ZUtleX1cIiBub3QgZm91bmQuYCk7XG4gICAgICB9XG4gICAgICB0aGlzLnByaXZhdGVLZXkgPSBmcy5yZWFkRmlsZVN5bmMocHJpdmF0ZUtleSk7XG4gICAgfVxuXG4gICAgLyoqIEBwcml2YXRlICovXG4gICAgdGhpcy5fand0R2VuZXJhdG9yID0gbmV3IEp3dEdlbmVyYXRvcigpO1xuICAgIHRoaXMuX2hhc2hHZW5lcmF0b3IgPSBuZXcgSGFzaEdlbmVyYXRvcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGEgSnd0IHVzaW5nIHRoZSBQcml2YXRlIEtleSBpbiB0aGUgQ3JlZGVudGlhbHMuXG4gICAqIEJ5IGRlZmF1bHQgdGhlIGNyZWRlbnRpYWxzLmFwcGxpY2F0aW9uSWQgd2lsbCBiZSB1c2VkIHdoZW4gY3JlYXRpbmcgdGhlIHRva2VuLlxuICAgKiBIb3dldmVyLCB0aGlzIGNhbiBiZSBvdmVyd3JpdHRlbi5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IFthcHBsaWNhdGlvbklkXSBhbiBhcHBsaWNhdGlvbiBJRCB0byBiZSB1c2VkIGluc3RlYWQgb2YgdGhlXG4gICAqICAgICAgICAgICAgICAgIGRlZmF1bHQgQ3JlZGVudGlhbHMuYXBwbGljYXRpb25JZCB2YWx1ZS5cbiAgICpcbiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGdlbmVyYXRlZCBKV1RcbiAgICovXG4gIGdlbmVyYXRlSnd0KFxuICAgIGFwcGxpY2F0aW9uSWQgPSB0aGlzLmFwcGxpY2F0aW9uSWQsXG4gICAgcHJpdmF0ZUtleSA9IHRoaXMucHJpdmF0ZUtleVxuICApIHtcbiAgICB2YXIgY2xhaW1zID0ge1xuICAgICAgYXBwbGljYXRpb25faWQ6IGFwcGxpY2F0aW9uSWQsXG4gICAgfTtcbiAgICB2YXIgdG9rZW4gPSB0aGlzLl9qd3RHZW5lcmF0b3IuZ2VuZXJhdGUocHJpdmF0ZUtleSwgY2xhaW1zKTtcbiAgICByZXR1cm4gdG9rZW47XG4gIH1cblxuICBnZW5lcmF0ZVNpZ25hdHVyZShcbiAgICBwYXJhbXMsXG4gICAgc2lnbmF0dXJlU2VjcmV0ID0gdGhpcy5zaWduYXR1cmVTZWNyZXQsXG4gICAgc2lnbmF0dXJlTWV0aG9kID0gdGhpcy5zaWduYXR1cmVNZXRob2RcbiAgKSB7XG4gICAgcmV0dXJuIHRoaXMuX2hhc2hHZW5lcmF0b3IuZ2VuZXJhdGUoXG4gICAgICBzaWduYXR1cmVNZXRob2QsXG4gICAgICBzaWduYXR1cmVTZWNyZXQsXG4gICAgICBwYXJhbXNcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIFVzZWQgZm9yIHRlc3RpbmcgcHVycG9zZXMgb25seS5cbiAgICovXG4gIF9zZXRKd3RHZW5lcmF0b3IoZ2VuZXJhdG9yKSB7XG4gICAgdGhpcy5fand0R2VuZXJhdG9yID0gZ2VuZXJhdG9yO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIFVzZWQgZm9yIHRlc3RpbmcgcHVycG9zZXMgb25seS5cbiAgICovXG4gIF9zZXRIYXNoR2VuZXJhdG9yKGdlbmVyYXRvcikge1xuICAgIHRoaXMuX2hhc2hHZW5lcmF0b3IgPSBnZW5lcmF0b3I7XG4gIH1cblxuICAvKipcbiAgICogRW5zdXJlcyBhIGNyZWRlbnRpYWxzIGluc3RhbmNlIGlzIHVzZWQuXG4gICAqXG4gICAqIEtleS9TZWNyZXQgY3JlZGVudGlhbHMgYXJlIG9ubHkgc3VwcG9ydGVkIGF0IHByZXNlbnQuXG4gICAqL1xuICBzdGF0aWMgcGFyc2Uob2JqKSB7XG4gICAgaWYgKG9iaiBpbnN0YW5jZW9mIENyZWRlbnRpYWxzKSB7XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3IENyZWRlbnRpYWxzKFxuICAgICAgICBvYmouYXBpS2V5LFxuICAgICAgICBvYmouYXBpU2VjcmV0LFxuICAgICAgICBvYmoucHJpdmF0ZUtleSxcbiAgICAgICAgb2JqLmFwcGxpY2F0aW9uSWQsXG4gICAgICAgIG9iai5zaWduYXR1cmVTZWNyZXQsXG4gICAgICAgIG9iai5zaWduYXR1cmVNZXRob2RcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENyZWRlbnRpYWxzO1xuIl19