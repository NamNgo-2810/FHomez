"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var https = require("https");

var http = require("http");

var request = require("request");

var querystring = require("querystring");

var URL = require("url").URL;

var isValidUrl = s => {
  if (!s || s === null) return false;

  try {
    if (s === "api.nexmo.com") return s;
    var o = new URL(s);
    return o.host;
  } catch (err) {
    return false;
  }
};

class HttpClient {
  constructor(options, credentials) {
    var hostOverride = isValidUrl(options.host);
    this.credentials = credentials;
    this.host = hostOverride ? hostOverride : "rest.nexmo.com";
    this.port = options.port || 443;
    this.https = options.https || https;
    this.http = options.http || http;
    this.headers = {
      "Content-Type": "application/x-www-form-urlencoded",
      Accept: "application/json"
    };
    this.logger = options.logger;
    this.timeout = options.timeout;
    this.requestLib = request;

    if (options.userAgent) {
      this.headers["User-Agent"] = options.userAgent;
    }
  }

  request(endpoint, method, callback) {
    var skipJsonParsing = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var customResponseParser = arguments.length > 4 ? arguments[4] : undefined;

    if (typeof method === "function") {
      callback = method;
      endpoint.method = endpoint.method || "GET";
    } else if (typeof method !== "undefined") {
      endpoint.method = method;
    }

    if (endpoint.method === "POST" || endpoint.method === "DELETE") {// TODO: verify the following fix is required
      // Fix broken due ot 411 Content-Length error now sent by Vonage API
      // PL 2016-Sept-6 - commented out Content-Length 0
      // headers['Content-Length'] = 0;
    }

    var options = {
      host: endpoint.host ? endpoint.host : this.host,
      port: this.port,
      path: endpoint.path,
      method: endpoint.method,
      headers: Object.assign({}, this.headers)
    };

    if (this.timeout !== undefined) {
      options.timeout = this.timeout;
    } // Allow existing headers to be overridden
    // Allow new headers to be added


    if (endpoint.headers) {
      Object.keys(endpoint.headers).forEach(function (key) {
        options.headers[key] = endpoint.headers[key];
      });
    }

    if (this.credentials.signatureSecret && this.credentials.signatureMethod) {
      var splitPath = options.path.split(/\?(.+)/);
      var path = splitPath[0];
      var params = querystring.decode(splitPath[1]); // add timestamp if not already present

      if (!params.timestamp) {
        params.timestamp = new Date().getTime() / 1000 | 0; // floor to seconds

        params.timestamp = params.timestamp.toString();
      } // strip API Secret


      delete params.api_secret;
      var hash = this.credentials.generateSignature(params);
      var query = ""; // rebuild query

      Object.keys(params).sort().forEach(key => {
        query += "&" + key + "=" + encodeURI(params[key]);
      }); // replace the first & with ?

      query = query.replace(/&/i, "?");
      options.path = "".concat(path).concat(query, "&sig=").concat(hash);
    }

    this.logger.info("Request:", options, "\nBody:", endpoint.body);
    var request;

    if (options.port === 443) {
      request = this.https.request(options);
    } else {
      request = this.http.request(options);
    }

    request.end(endpoint.body); // Keep an array of String or Buffers,
    // depending on content type (binary or JSON) of response

    var responseData = [];
    request.on("response", response => {
      var isBinary = response.headers["content-type"] === "application/octet-stream";

      if (!isBinary) {
        response.setEncoding("utf8");
      }

      response.on("data", chunk => {
        responseData.push(chunk);
      });
      response.on("end", () => {
        this.logger.info("response ended:", response.statusCode);

        if (callback) {
          if (isBinary) {
            responseData = Buffer.concat(responseData);
          }

          this.__parseResponse(response, responseData, endpoint.method, callback, skipJsonParsing, customResponseParser);
        }
      });
      response.on("close", e => {
        if (e) {
          this.logger.error("problem with API request detailed stacktrace below ");
          this.logger.error(e);
          callback(e);
        }
      });
    });
    request.on("error", e => {
      this.logger.error("problem with API request detailed stacktrace below ");
      this.logger.error(e);
      callback(e);
    });
  }

  __parseResponse(httpResponse, data, method, callback, skipJsonParsing, customResponseParser) {
    var isArrayOrBuffer = data instanceof Array || data instanceof Buffer;

    if (!isArrayOrBuffer) {
      throw new Error("data should be of type Array or Buffer");
    }

    var status = httpResponse.statusCode;
    var headers = httpResponse.headers;
    var response = null;
    var error = null;

    try {
      if (status >= 500) {
        error = {
          message: "Server Error",
          statusCode: status
        };
      } else if (httpResponse.headers["content-type"] === "application/octet-stream") {
        response = data;
      } else if (status === 429) {
        // 429 does not return a parsable body
        if (!headers["retry-after"]) {
          // retry based on allowed per second
          var retryAfterMillis = method === "POST" ? 1000 / 2 : 1000 / 5;
          headers["retry-after"] = retryAfterMillis;
        }

        error = {
          body: data.join("")
        };
      } else if (status === 204) {
        response = null;
      } else if (status >= 400 || status < 200) {
        error = {
          body: JSON.parse(data.join("")),
          headers
        };
      } else if (method !== "DELETE") {
        if (!!skipJsonParsing) {
          response = data.join("");
        } else {
          response = JSON.parse(data.join(""));
        }
      } else {
        response = data;
      }
    } catch (parseError) {
      this.logger.error(parseError);
      this.logger.error("could not convert API response to JSON, above error is ignored and raw API response is returned to client");
      this.logger.error("Raw Error message from API ");
      this.logger.error("\"".concat(data, "\""));
      error = {
        status: status,
        message: "The API response could not be parsed.",
        body: data.join(""),
        parseError: parseError
      };
    }

    if (error) {
      error.statusCode = status;
      error.headers = headers;
    }

    if (typeof callback === "function") {
      if (typeof customResponseParser === "function") {
        // don't try to parse the response on errors
        if (response) {
          response = customResponseParser(response);
        }
      }

      callback(error, response);
    }
  }

  _addLimitedAccessMessageToErrors(callback, limitedAccessStatus) {
    return function (err, data) {
      if (err && err.status == limitedAccessStatus) {
        err._INFO_ = "This endpoint may need activating on your account. Please email support@nexmo.com for more information";
      }

      return callback(err, data);
    };
  }

  get(path, params, callback) {
    var useJwt = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var useBasicAuth = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;

    if (!callback) {
      if (typeof params == "function") {
        callback = params;
        params = {};
      }
    }

    params = params || {};

    if (!useJwt && !useBasicAuth) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    path = path + "?" + querystring.stringify(params);
    var headers = {
      "Content-Type": "application/json"
    };

    if (useJwt) {
      headers["Authorization"] = "Bearer ".concat(this.credentials.generateJwt());
    }

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    this.request({
      path: path,
      headers
    }, "GET", callback);
  }

  delete(path, callback, useJwt, useBasicAuth) {
    var params = {};

    if (!useJwt && !useBasicAuth) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    var headers = {};

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    path = path + "?" + querystring.stringify(params);
    this.request({
      path: path,
      headers
    }, "DELETE", callback);
  }

  postFile(path, options, callback, useJwt) {
    var qs = {};

    if (!useJwt) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    if (Object.keys(qs).length) {
      var joinChar = "?";

      if (path.indexOf(joinChar) !== -1) {
        joinChar = "&";
      }

      path = path + joinChar + querystring.stringify(qs);
    }

    var file = options.file;
    delete options.file; // We don't send this as metadata

    var formData = {};

    if (file) {
      formData["filedata"] = {
        value: file,
        options: {
          filename: options.filename || null
        }
      };
    }

    if (options.info) {
      formData.info = JSON.stringify(options.info);
    }

    if (options.url) {
      formData.url = options.url;
    }

    var protocol = this.port === 443 ? "https://" : "http://";
    this.requestLib.post({
      url: protocol + this.host + path,
      formData: formData,
      headers: {
        Authorization: "Bearer ".concat(this.credentials.generateJwt())
      }
    }, callback);
  }

  post(path, params, callback, useJwt, headers) {
    var qs = {};

    if (!useJwt) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    var joinChar = "?";

    if (path.indexOf(joinChar) !== -1) {
      joinChar = "&";
    }

    path = path + joinChar + querystring.stringify(qs);
    headers = headers || {};

    if (useJwt) {
      headers["Authorization"] = "Bearer ".concat(this.credentials.generateJwt());
    }

    var encodedParams;

    if (headers["Content-Type"] == "application/json") {
      encodedParams = JSON.stringify(params);
    } else {
      encodedParams = querystring.stringify(params);
    }

    this.request({
      path,
      body: encodedParams,
      headers
    }, "POST", callback);
  }

  postJson(path, params, callback, useJwt, useBasicAuth) {
    var qs = {};

    if (!useJwt && !useBasicAuth) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    var joinChar = "?";

    if (path.indexOf(joinChar) !== -1) {
      joinChar = "&";
    }

    path = path + joinChar + querystring.stringify(qs);
    var headers = {
      "Content-Type": "application/json"
    };

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    this.request({
      path: path,
      body: JSON.stringify(params),
      headers
    }, "POST", callback);
  }

  postUseQueryString(path, params, callback, useJwt) {
    params = params || {};

    if (!useJwt) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    path = path + "?" + querystring.stringify(params);
    this.request({
      path: path
    }, "POST", callback);
  }

}

var _default = HttpClient;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9IdHRwQ2xpZW50LmpzIl0sIm5hbWVzIjpbImh0dHBzIiwicmVxdWlyZSIsImh0dHAiLCJyZXF1ZXN0IiwicXVlcnlzdHJpbmciLCJVUkwiLCJpc1ZhbGlkVXJsIiwicyIsIm8iLCJob3N0IiwiZXJyIiwiSHR0cENsaWVudCIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImNyZWRlbnRpYWxzIiwiaG9zdE92ZXJyaWRlIiwicG9ydCIsImhlYWRlcnMiLCJBY2NlcHQiLCJsb2dnZXIiLCJ0aW1lb3V0IiwicmVxdWVzdExpYiIsInVzZXJBZ2VudCIsImVuZHBvaW50IiwibWV0aG9kIiwiY2FsbGJhY2siLCJza2lwSnNvblBhcnNpbmciLCJjdXN0b21SZXNwb25zZVBhcnNlciIsInBhdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJ1bmRlZmluZWQiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsInNpZ25hdHVyZVNlY3JldCIsInNpZ25hdHVyZU1ldGhvZCIsInNwbGl0UGF0aCIsInNwbGl0IiwicGFyYW1zIiwiZGVjb2RlIiwidGltZXN0YW1wIiwiRGF0ZSIsImdldFRpbWUiLCJ0b1N0cmluZyIsImFwaV9zZWNyZXQiLCJoYXNoIiwiZ2VuZXJhdGVTaWduYXR1cmUiLCJxdWVyeSIsInNvcnQiLCJlbmNvZGVVUkkiLCJyZXBsYWNlIiwiaW5mbyIsImJvZHkiLCJlbmQiLCJyZXNwb25zZURhdGEiLCJvbiIsInJlc3BvbnNlIiwiaXNCaW5hcnkiLCJzZXRFbmNvZGluZyIsImNodW5rIiwicHVzaCIsInN0YXR1c0NvZGUiLCJCdWZmZXIiLCJjb25jYXQiLCJfX3BhcnNlUmVzcG9uc2UiLCJlIiwiZXJyb3IiLCJodHRwUmVzcG9uc2UiLCJkYXRhIiwiaXNBcnJheU9yQnVmZmVyIiwiQXJyYXkiLCJFcnJvciIsInN0YXR1cyIsIm1lc3NhZ2UiLCJyZXRyeUFmdGVyTWlsbGlzIiwiam9pbiIsIkpTT04iLCJwYXJzZSIsInBhcnNlRXJyb3IiLCJfYWRkTGltaXRlZEFjY2Vzc01lc3NhZ2VUb0Vycm9ycyIsImxpbWl0ZWRBY2Nlc3NTdGF0dXMiLCJfSU5GT18iLCJnZXQiLCJ1c2VKd3QiLCJ1c2VCYXNpY0F1dGgiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJzdHJpbmdpZnkiLCJnZW5lcmF0ZUp3dCIsImZyb20iLCJkZWxldGUiLCJwb3N0RmlsZSIsInFzIiwibGVuZ3RoIiwiam9pbkNoYXIiLCJpbmRleE9mIiwiZmlsZSIsImZvcm1EYXRhIiwidmFsdWUiLCJmaWxlbmFtZSIsInVybCIsInByb3RvY29sIiwicG9zdCIsIkF1dGhvcml6YXRpb24iLCJlbmNvZGVkUGFyYW1zIiwicG9zdEpzb24iLCJwb3N0VXNlUXVlcnlTdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFJQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxPQUFELENBQW5COztBQUNBLElBQUlDLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBbEI7O0FBQ0EsSUFBSUUsT0FBTyxHQUFHRixPQUFPLENBQUMsU0FBRCxDQUFyQjs7QUFDQSxJQUFJRyxXQUFXLEdBQUdILE9BQU8sQ0FBQyxhQUFELENBQXpCOztBQUNBLElBQUlJLEdBQUcsR0FBR0osT0FBTyxDQUFDLEtBQUQsQ0FBUCxDQUFlSSxHQUF6Qjs7QUFFQSxJQUFNQyxVQUFVLEdBQUlDLENBQUQsSUFBTztBQUN4QixNQUFJLENBQUNBLENBQUQsSUFBTUEsQ0FBQyxLQUFLLElBQWhCLEVBQXNCLE9BQU8sS0FBUDs7QUFFdEIsTUFBSTtBQUNGLFFBQUlBLENBQUMsS0FBSyxlQUFWLEVBQTJCLE9BQU9BLENBQVA7QUFDM0IsUUFBSUMsQ0FBQyxHQUFHLElBQUlILEdBQUosQ0FBUUUsQ0FBUixDQUFSO0FBQ0EsV0FBT0MsQ0FBQyxDQUFDQyxJQUFUO0FBQ0QsR0FKRCxDQUlFLE9BQU9DLEdBQVAsRUFBWTtBQUNaLFdBQU8sS0FBUDtBQUNEO0FBQ0YsQ0FWRDs7QUFZQSxNQUFNQyxVQUFOLENBQWlCO0FBQ2ZDLEVBQUFBLFdBQVcsQ0FBQ0MsT0FB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QixXQUFXLENBQUNvRixTQUFaLENBQXNCakQsTUFBdEIsQ0FBcEI7QUFFQSxTQUFLcEMsT0FBTCxDQUNFO0FBQ0V5QixNQUFBQSxJQUFJLEVBQUVBO0FBRFIsS0FERixFQUlFLE1BSkYsRUFLRUgsUUFMRjtBQU9EOztBQTdiYzs7ZUFnY0ZkLFUiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgaHR0cHMgPSByZXF1aXJlKFwiaHR0cHNcIik7XG52YXIgaHR0cCA9IHJlcXVpcmUoXCJodHRwXCIpO1xudmFyIHJlcXVlc3QgPSByZXF1aXJlKFwicmVxdWVzdFwiKTtcbnZhciBxdWVyeXN0cmluZyA9IHJlcXVpcmUoXCJxdWVyeXN0cmluZ1wiKTtcbnZhciBVUkwgPSByZXF1aXJlKFwidXJsXCIpLlVSTDtcblxuY29uc3QgaXNWYWxpZFVybCA9IChzKSA9PiB7XG4gIGlmICghcyB8fCBzID09PSBudWxsKSByZXR1cm4gZmFsc2U7XG5cbiAgdHJ5IHtcbiAgICBpZiAocyA9PT0gXCJhcGkubmV4bW8uY29tXCIpIHJldHVybiBzO1xuICAgIGxldCBvID0gbmV3IFVSTChzKTtcbiAgICByZXR1cm4gby5ob3N0O1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn07XG5cbmNsYXNzIEh0dHBDbGllbnQge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zLCBjcmVkZW50aWFscykge1xuICAgIGxldCBob3N0T3ZlcnJpZGUgPSBpc1ZhbGlkVXJsKG9wdGlvbnMuaG9zdCk7XG4gICAgdGhpcy5jcmVkZW50aWFscyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMuaG9zdCA9IGhvc3RPdmVycmlkZSA/IGhvc3RPdmVycmlkZSA6IGByZXN0Lm5leG1vLmNvbWA7XG4gICAgdGhpcy5wb3J0ID0gb3B0aW9ucy5wb3J0IHx8IDQ0MztcbiAgICB0aGlzLmh0dHBzID0gb3B0aW9ucy5odHRwcyB8fCBodHRwcztcbiAgICB0aGlzLmh0dHAgPSBvcHRpb25zLmh0dHAgfHwgaHR0cDtcbiAgICB0aGlzLmhlYWRlcnMgPSB7XG4gICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZFwiLFxuICAgICAgQWNjZXB0OiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICB9O1xuICAgIHRoaXMubG9nZ2VyID0gb3B0aW9ucy5sb2dnZXI7XG4gICAgdGhpcy50aW1lb3V0ID0gb3B0aW9ucy50aW1lb3V0O1xuICAgIHRoaXMucmVxdWVzdExpYiA9IHJlcXVlc3Q7XG5cbiAgICBpZiAob3B0aW9ucy51c2VyQWdlbnQpIHtcbiAgICAgIHRoaXMuaGVhZGVyc1tcIlVzZXItQWdlbnRcIl0gPSBvcHRpb25zLnVzZXJBZ2VudDtcbiAgICB9XG4gIH1cblxuICByZXF1ZXN0KFxuICAgIGVuZHBvaW50LFxuICAgIG1ldGhvZCxcbiAgICBjYWxsYmFjayxcbiAgICBza2lwSnNvblBhcnNpbmcgPSBmYWxzZSxcbiAgICBjdXN0b21SZXNwb25zZVBhcnNlclxuICApIHtcbiAgICBpZiAodHlwZW9mIG1ldGhvZCA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjYWxsYmFjayA9IG1ldGhvZDtcbiAgICAgIGVuZHBvaW50Lm1ldGhvZCA9IGVuZHBvaW50Lm1ldGhvZCB8fCBcIkdFVFwiO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIG1ldGhvZCAhPT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgZW5kcG9pbnQubWV0aG9kID0gbWV0aG9kO1xuICAgIH1cblxuICAgIGlmIChlbmRwb2ludC5tZXRob2QgPT09IFwiUE9TVFwiIHx8IGVuZHBvaW50Lm1ldGhvZCA9PT0gXCJERUxFVEVcIikge1xuICAgICAgLy8gVE9ETzogdmVyaWZ5IHRoZSBmb2xsb3dpbmcgZml4IGlzIHJlcXVpcmVkXG4gICAgICAvLyBGaXggYnJva2VuIGR1ZSBvdCA0MTEgQ29udGVudC1MZW5ndGggZXJyb3Igbm93IHNlbnQgYnkgVm9uYWdlIEFQSVxuICAgICAgLy8gUEwgMjAxNi1TZXB0LTYgLSBjb21tZW50ZWQgb3V0IENvbnRlbnQtTGVuZ3RoIDBcbiAgICAgIC8vIGhlYWRlcnNbJ0NvbnRlbnQtTGVuZ3RoJ10gPSAwO1xuICAgIH1cbiAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgIGhvc3Q6IGVuZHBvaW50Lmhvc3QgPyBlbmRwb2ludC5ob3N0IDogdGhpcy5ob3N0LFxuICAgICAgcG9ydDogdGhpcy5wb3J0LFxuICAgICAgcGF0aDogZW5kcG9pbnQucGF0aCxcbiAgICAgIG1ldGhvZDogZW5kcG9pbnQubWV0aG9kLFxuICAgICAgaGVhZGVyczogT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5oZWFkZXJzKSxcbiAgICB9O1xuXG4gICAgaWYgKHRoaXMudGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBvcHRpb25zLnRpbWVvdXQgPSB0aGlzLnRpbWVvdXQ7XG4gICAgfVxuXG4gICAgLy8gQWxsb3cgZXhpc3RpbmcgaGVhZGVycyB0byBiZSBvdmVycmlkZGVuXG4gICAgLy8gQWxsb3cgbmV3IGhlYWRlcnMgdG8gYmUgYWRkZWRcbiAgICBpZiAoZW5kcG9pbnQuaGVhZGVycykge1xuICAgICAgT2JqZWN0LmtleXMoZW5kcG9pbnQuaGVhZGVycykuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgIG9wdGlvbnMuaGVhZGVyc1trZXldID0gZW5kcG9pbnQuaGVhZGVyc1trZXldO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY3JlZGVudGlhbHMuc2lnbmF0dXJlU2VjcmV0ICYmIHRoaXMuY3JlZGVudGlhbHMuc2lnbmF0dXJlTWV0aG9kKSB7XG4gICAgICBjb25zdCBzcGxpdFBhdGggPSBvcHRpb25zLnBhdGguc3BsaXQoL1xcPyguKykvKTtcbiAgICAgIGNvbnN0IHBhdGggPSBzcGxpdFBhdGhbMF07XG5cbiAgICAgIHZhciBwYXJhbXMgPSBxdWVyeXN0cmluZy5kZWNvZGUoc3BsaXRQYXRoWzFdKTtcblxuICAgICAgLy8gYWRkIHRpbWVzdGFtcCBpZiBub3QgYWxyZWFkeSBwcmVzZW50XG4gICAgICBpZiAoIXBhcmFtcy50aW1lc3RhbXApIHtcbiAgICAgICAgcGFyYW1zLnRpbWVzdGFtcCA9IChuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwMDApIHwgMDsgLy8gZmxvb3IgdG8gc2Vjb25kc1xuICAgICAgICBwYXJhbXMudGltZXN0YW1wID0gcGFyYW1zLnRpbWVzdGFtcC50b1N0cmluZygpO1xuICAgICAgfVxuXG4gICAgICAvLyBzdHJpcCBBUEkgU2VjcmV0XG4gICAgICBkZWxldGUgcGFyYW1zLmFwaV9zZWNyZXQ7XG5cbiAgICAgIGNvbnN0IGhhc2ggPSB0aGlzLmNyZWRlbnRpYWxzLmdlbmVyYXRlU2lnbmF0dXJlKHBhcmFtcyk7XG5cbiAgICAgIHZhciBxdWVyeSA9IFwiXCI7XG5cbiAgICAgIC8vIHJlYnVpbGQgcXVlcnlcbiAgICAgIE9iamVjdC5rZXlzKHBhcmFtcylcbiAgICAgICAgLnNvcnQoKVxuICAgICAgICAuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgcXVlcnkgKz0gXCImXCIgKyBrZXkgKyBcIj1cIiArIGVuY29kZVVSSShwYXJhbXNba2V5XSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAvLyByZXBsYWNlIHRoZSBmaXJzdCAmIHdpdGggP1xuICAgICAgcXVlcnkgPSBxdWVyeS5yZXBsYWNlKC8mL2ksIFwiP1wiKTtcblxuICAgICAgb3B0aW9ucy5wYXRoID0gYCR7cGF0aH0ke3F1ZXJ5fSZzaWc9JHtoYXNofWA7XG4gICAgfVxuXG4gICAgdGhpcy5sb2dnZXIuaW5mbyhcIlJlcXVlc3Q6XCIsIG9wdGlvbnMsIFwiXFxuQm9keTpcIiwgZW5kcG9pbnQuYm9keSk7XG4gICAgdmFyIHJlcXVlc3Q7XG5cbiAgICBpZiAob3B0aW9ucy5wb3J0ID09PSA0NDMpIHtcbiAgICAgIHJlcXVlc3QgPSB0aGlzLmh0dHBzLnJlcXVlc3Qob3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcXVlc3QgPSB0aGlzLmh0dHAucmVxdWVzdChvcHRpb25zKTtcbiAgICB9XG5cbiAgICByZXF1ZXN0LmVuZChlbmRwb2ludC5ib2R5KTtcblxuICAgIC8vIEtlZXAgYW4gYXJyYXkgb2YgU3RyaW5nIG9yIEJ1ZmZlcnMsXG4gICAgLy8gZGVwZW5kaW5nIG9uIGNvbnRlbnQgdHlwZSAoYmluYXJ5IG9yIEpTT04pIG9mIHJlc3BvbnNlXG4gICAgdmFyIHJlc3BvbnNlRGF0YSA9IFtdO1xuXG4gICAgcmVxdWVzdC5vbihcInJlc3BvbnNlXCIsIChyZXNwb25zZSkgPT4ge1xuICAgICAgdmFyIGlzQmluYXJ5ID1cbiAgICAgICAgcmVzcG9uc2UuaGVhZGVyc1tcImNvbnRlbnQtdHlwZVwiXSA9PT0gXCJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW1cIjtcbiAgICAgIGlmICghaXNCaW5hcnkpIHtcbiAgICAgICAgcmVzcG9uc2Uuc2V0RW5jb2RpbmcoXCJ1dGY4XCIpO1xuICAgICAgfVxuXG4gICAgICByZXNwb25zZS5vbihcImRhdGFcIiwgKGNodW5rKSA9PiB7XG4gICAgICAgIHJlc3BvbnNlRGF0YS5wdXNoKGNodW5rKTtcbiAgICAgIH0pO1xuXG4gICAgICByZXNwb25zZS5vbihcImVuZFwiLCAoKSA9PiB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmluZm8oXCJyZXNwb25zZSBlbmRlZDpcIiwgcmVzcG9uc2Uuc3RhdHVzQ29kZSk7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgIGlmIChpc0JpbmFyeSkge1xuICAgICAgICAgICAgcmVzcG9uc2VEYXRhID0gQnVmZmVyLmNvbmNhdChyZXNwb25zZURhdGEpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuX19wYXJzZVJlc3BvbnNlKFxuICAgICAgICAgICAgcmVzcG9uc2UsXG4gICAgICAgICAgICByZXNwb25zZURhdGEsXG4gICAgICAgICAgICBlbmRwb2ludC5tZXRob2QsXG4gICAgICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgICAgIHNraXBKc29uUGFyc2luZyxcbiAgICAgICAgICAgIGN1c3RvbVJlc3BvbnNlUGFyc2VyXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXNwb25zZS5vbihcImNsb3NlXCIsIChlKSA9PiB7XG4gICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBcInByb2JsZW0gd2l0aCBBUEkgcmVxdWVzdCBkZXRhaWxlZCBzdGFja3RyYWNlIGJlbG93IFwiXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmVxdWVzdC5vbihcImVycm9yXCIsIChlKSA9PiB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcInByb2JsZW0gd2l0aCBBUEkgcmVxdWVzdCBkZXRhaWxlZCBzdGFja3RyYWNlIGJlbG93IFwiKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGUpO1xuICAgICAgY2FsbGJhY2soZSk7XG4gICAgfSk7XG4gIH1cblxuICBfX3BhcnNlUmVzcG9uc2UoXG4gICAgaHR0cFJlc3BvbnNlLFxuICAgIGRhdGEsXG4gICAgbWV0aG9kLFxuICAgIGNhbGxiYWNrLFxuICAgIHNraXBKc29uUGFyc2luZyxcbiAgICBjdXN0b21SZXNwb25zZVBhcnNlclxuICApIHtcbiAgICBjb25zdCBpc0FycmF5T3JCdWZmZXIgPSBkYXRhIGluc3RhbmNlb2YgQXJyYXkgfHwgZGF0YSBpbnN0YW5jZW9mIEJ1ZmZlcjtcbiAgICBpZiAoIWlzQXJyYXlPckJ1ZmZlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZGF0YSBzaG91bGQgYmUgb2YgdHlwZSBBcnJheSBvciBCdWZmZXJcIik7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhdHVzID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgY29uc3QgaGVhZGVycyA9IGh0dHBSZXNwb25zZS5oZWFkZXJzO1xuXG4gICAgbGV0IHJlc3BvbnNlID0gbnVsbDtcbiAgICB2YXIgZXJyb3IgPSBudWxsO1xuXG4gICAgdHJ5IHtcbiAgICAgIGlmIChzdGF0dXMgPj0gNTAwKSB7XG4gICAgICAgIGVycm9yID0ge1xuICAgICAgICAgIG1lc3NhZ2U6IFwiU2VydmVyIEVycm9yXCIsXG4gICAgICAgICAgc3RhdHVzQ29kZTogc3RhdHVzLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgaHR0cFJlc3BvbnNlLmhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl0gPT09IFwiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtXCJcbiAgICAgICkge1xuICAgICAgICByZXNwb25zZSA9IGRhdGE7XG4gICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gNDI5KSB7XG4gICAgICAgIC8vIDQyOSBkb2VzIG5vdCByZXR1cm4gYSBwYXJzYWJsZSBib2R5XG4gICAgICAgIGlmICghaGVhZGVyc1tcInJldHJ5LWFmdGVyXCJdKSB7XG4gICAgICAgICAgLy8gcmV0cnkgYmFzZWQgb24gYWxsb3dlZCBwZXIgc2Vjb25kXG4gICAgICAgICAgY29uc3QgcmV0cnlBZnRlck1pbGxpcyA9IG1ldGhvZCA9PT0gXCJQT1NUXCIgPyAxMDAwIC8gMiA6IDEwMDAgLyA1O1xuICAgICAgICAgIGhlYWRlcnNbXCJyZXRyeS1hZnRlclwiXSA9IHJldHJ5QWZ0ZXJNaWxsaXM7XG4gICAgICAgIH1cbiAgICAgICAgZXJyb3IgPSB7XG4gICAgICAgICAgYm9keTogZGF0YS5qb2luKFwiXCIpLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDIwNCkge1xuICAgICAgICByZXNwb25zZSA9IG51bGw7XG4gICAgICB9IGVsc2UgaWYgKHN0YXR1cyA+PSA0MDAgfHwgc3RhdHVzIDwgMjAwKSB7XG4gICAgICAgIGVycm9yID0ge1xuICAgICAgICAgIGJvZHk6IEpTT04ucGFyc2UoZGF0YS5qb2luKFwiXCIpKSxcbiAgICAgICAgICBoZWFkZXJzLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmIChtZXRob2QgIT09IFwiREVMRVRFXCIpIHtcbiAgICAgICAgaWYgKCEhc2tpcEpzb25QYXJzaW5nKSB7XG4gICAgICAgICAgcmVzcG9uc2UgPSBkYXRhLmpvaW4oXCJcIik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzcG9uc2UgPSBKU09OLnBhcnNlKGRhdGEuam9pbihcIlwiKSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3BvbnNlID0gZGF0YTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChwYXJzZUVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihwYXJzZUVycm9yKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBcImNvdWxkIG5vdCBjb252ZXJ0IEFQSSByZXNwb25zZSB0byBKU09OLCBhYm92ZSBlcnJvciBpcyBpZ25vcmVkIGFuZCByYXcgQVBJIHJlc3BvbnNlIGlzIHJldHVybmVkIHRvIGNsaWVudFwiXG4gICAgICApO1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXCJSYXcgRXJyb3IgbWVzc2FnZSBmcm9tIEFQSSBcIik7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgXCIke2RhdGF9XCJgKTtcblxuICAgICAgZXJyb3IgPSB7XG4gICAgICAgIHN0YXR1czogc3RhdHVzLFxuICAgICAgICBtZXNzYWdlOiBcIlRoZSBBUEkgcmVzcG9uc2UgY291bGQgbm90IGJlIHBhcnNlZC5cIixcbiAgICAgICAgYm9keTogZGF0YS5qb2luKFwiXCIpLFxuICAgICAgICBwYXJzZUVycm9yOiBwYXJzZUVycm9yLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGVycm9yLnN0YXR1c0NvZGUgPSBzdGF0dXM7XG4gICAgICBlcnJvci5oZWFkZXJzID0gaGVhZGVycztcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tUmVzcG9uc2VQYXJzZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAvLyBkb24ndCB0cnkgdG8gcGFyc2UgdGhlIHJlc3BvbnNlIG9uIGVycm9yc1xuICAgICAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgICAgICByZXNwb25zZSA9IGN1c3RvbVJlc3BvbnNlUGFyc2VyKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY2FsbGJhY2soZXJyb3IsIHJlc3BvbnNlKTtcbiAgICB9XG4gIH1cblxuICBfYWRkTGltaXRlZEFjY2Vzc01lc3NhZ2VUb0Vycm9ycyhjYWxsYmFjaywgbGltaXRlZEFjY2Vzc1N0YXR1cykge1xuICAgIHJldHVybiBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7XG4gICAgICBpZiAoZXJyICYmIGVyci5zdGF0dXMgPT0gbGltaXRlZEFjY2Vzc1N0YXR1cykge1xuICAgICAgICBlcnIuX0lORk9fID1cbiAgICAgICAgICBcIlRoaXMgZW5kcG9pbnQgbWF5IG5lZWQgYWN0aXZhdGluZyBvbiB5b3VyIGFjY291bnQuIFBsZWFzZSBlbWFpbCBzdXBwb3J0QG5leG1vLmNvbSBmb3IgbW9yZSBpbmZvcm1hdGlvblwiO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gY2FsbGJhY2soZXJyLCBkYXRhKTtcbiAgICB9O1xuICB9XG5cbiAgZ2V0KHBhdGgsIHBhcmFtcywgY2FsbGJhY2ssIHVzZUp3dCA9IGZhbHNlLCB1c2VCYXNpY0F1dGggPSBmYWxzZSkge1xuICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IHBhcmFtcztcbiAgICAgICAgcGFyYW1zID0ge307XG4gICAgICB9XG4gICAgfVxuXG4gICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgIGlmICghdXNlSnd0ICYmICF1c2VCYXNpY0F1dGgpIHtcbiAgICAgIHBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBwYXRoID0gcGF0aCArIFwiP1wiICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHBhcmFtcyk7XG5cbiAgICBjb25zdCBoZWFkZXJzID0ge1xuICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgfTtcbiAgICBpZiAodXNlSnd0KSB7XG4gICAgICBoZWFkZXJzW1wiQXV0aG9yaXphdGlvblwiXSA9IGBCZWFyZXIgJHt0aGlzLmNyZWRlbnRpYWxzLmdlbmVyYXRlSnd0KCl9YDtcbiAgICB9XG4gICAgaWYgKHVzZUJhc2ljQXV0aCkge1xuICAgICAgaGVhZGVyc1tcIkF1dGhvcml6YXRpb25cIl0gPSBgQmFzaWMgJHtCdWZmZXIuZnJvbShcbiAgICAgICAgdGhpcy5jcmVkZW50aWFscy5hcGlLZXkgKyBcIjpcIiArIHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0XG4gICAgICApLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWA7XG4gICAgfVxuXG4gICAgdGhpcy5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgfSxcbiAgICAgIFwiR0VUXCIsXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBkZWxldGUocGF0aCwgY2FsbGJhY2ssIHVzZUp3dCwgdXNlQmFzaWNBdXRoKSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9O1xuICAgIGlmICghdXNlSnd0ICYmICF1c2VCYXNpY0F1dGgpIHtcbiAgICAgIHBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBsZXQgaGVhZGVycyA9IHt9O1xuXG4gICAgaWYgKHVzZUJhc2ljQXV0aCkge1xuICAgICAgaGVhZGVyc1tcIkF1dGhvcml6YXRpb25cIl0gPSBgQmFzaWMgJHtCdWZmZXIuZnJvbShcbiAgICAgICAgdGhpcy5jcmVkZW50aWFscy5hcGlLZXkgKyBcIjpcIiArIHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0XG4gICAgICApLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWA7XG4gICAgfVxuICAgIHBhdGggPSBwYXRoICsgXCI/XCIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocGFyYW1zKTtcblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgaGVhZGVycyxcbiAgICAgIH0sXG4gICAgICBcIkRFTEVURVwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgcG9zdEZpbGUocGF0aCwgb3B0aW9ucywgY2FsbGJhY2ssIHVzZUp3dCkge1xuICAgIGxldCBxcyA9IHt9O1xuICAgIGlmICghdXNlSnd0KSB7XG4gICAgICBxc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHFzW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIGlmIChPYmplY3Qua2V5cyhxcykubGVuZ3RoKSB7XG4gICAgICBsZXQgam9pbkNoYXIgPSBcIj9cIjtcbiAgICAgIGlmIChwYXRoLmluZGV4T2Yoam9pbkNoYXIpICE9PSAtMSkge1xuICAgICAgICBqb2luQ2hhciA9IFwiJlwiO1xuICAgICAgfVxuICAgICAgcGF0aCA9IHBhdGggKyBqb2luQ2hhciArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShxcyk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZSA9IG9wdGlvbnMuZmlsZTtcbiAgICBkZWxldGUgb3B0aW9ucy5maWxlOyAvLyBXZSBkb24ndCBzZW5kIHRoaXMgYXMgbWV0YWRhdGFcblxuICAgIGNvbnN0IGZvcm1EYXRhID0ge307XG5cbiAgICBpZiAoZmlsZSkge1xuICAgICAgZm9ybURhdGFbXCJmaWxlZGF0YVwiXSA9IHtcbiAgICAgICAgdmFsdWU6IGZpbGUsXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICBmaWxlbmFtZTogb3B0aW9ucy5maWxlbmFtZSB8fCBudWxsLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5pbmZvKSB7XG4gICAgICBmb3JtRGF0YS5pbmZvID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5pbmZvKTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy51cmwpIHtcbiAgICAgIGZvcm1EYXRhLnVybCA9IG9wdGlvbnMudXJsO1xuICAgIH1cblxuICAgIGxldCBwcm90b2NvbCA9IHRoaXMucG9ydCA9PT0gNDQzID8gXCJodHRwczovL1wiIDogXCJodHRwOi8vXCI7XG5cbiAgICB0aGlzLnJlcXVlc3RMaWIucG9zdChcbiAgICAgIHtcbiAgICAgICAgdXJsOiBwcm90b2NvbCArIHRoaXMuaG9zdCArIHBhdGgsXG4gICAgICAgIGZvcm1EYXRhOiBmb3JtRGF0YSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmNyZWRlbnRpYWxzLmdlbmVyYXRlSnd0KCl9YCxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBwb3N0KHBhdGgsIHBhcmFtcywgY2FsbGJhY2ssIHVzZUp3dCwgaGVhZGVycykge1xuICAgIGxldCBxcyA9IHt9O1xuICAgIGlmICghdXNlSnd0KSB7XG4gICAgICBxc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHFzW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIGxldCBqb2luQ2hhciA9IFwiP1wiO1xuICAgIGlmIChwYXRoLmluZGV4T2Yoam9pbkNoYXIpICE9PSAtMSkge1xuICAgICAgam9pbkNoYXIgPSBcIiZcIjtcbiAgICB9XG5cbiAgICBwYXRoID0gcGF0aCArIGpvaW5DaGFyICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHFzKTtcblxuICAgIGhlYWRlcnMgPSBoZWFkZXJzIHx8IHt9O1xuICAgIGlmICh1c2VKd3QpIHtcbiAgICAgIGhlYWRlcnNbXCJBdXRob3JpemF0aW9uXCJdID0gYEJlYXJlciAke3RoaXMuY3JlZGVudGlhbHMuZ2VuZXJhdGVKd3QoKX1gO1xuICAgIH1cblxuICAgIGxldCBlbmNvZGVkUGFyYW1zO1xuICAgIGlmIChoZWFkZXJzW1wiQ29udGVudC1UeXBlXCJdID09IFwiYXBwbGljYXRpb24vanNvblwiKSB7XG4gICAgICBlbmNvZGVkUGFyYW1zID0gSlNPTi5zdHJpbmdpZnkocGFyYW1zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZW5jb2RlZFBhcmFtcyA9IHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShwYXJhbXMpO1xuICAgIH1cblxuICAgIHRoaXMucmVxdWVzdCh7IHBhdGgsIGJvZHk6IGVuY29kZWRQYXJhbXMsIGhlYWRlcnMgfSwgXCJQT1NUXCIsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIHBvc3RKc29uKHBhdGgsIHBhcmFtcywgY2FsbGJhY2ssIHVzZUp3dCwgdXNlQmFzaWNBdXRoKSB7XG4gICAgbGV0IHFzID0ge307XG4gICAgaWYgKCF1c2VKd3QgJiYgIXVzZUJhc2ljQXV0aCkge1xuICAgICAgcXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlLZXk7XG4gICAgICBxc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBsZXQgam9pbkNoYXIgPSBcIj9cIjtcbiAgICBpZiAocGF0aC5pbmRleE9mKGpvaW5DaGFyKSAhPT0gLTEpIHtcbiAgICAgIGpvaW5DaGFyID0gXCImXCI7XG4gICAgfVxuXG4gICAgcGF0aCA9IHBhdGggKyBqb2luQ2hhciArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShxcyk7XG5cbiAgICBsZXQgaGVhZGVycyA9IHtcbiAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgIH07XG4gICAgaWYgKHVzZUJhc2ljQXV0aCkge1xuICAgICAgaGVhZGVyc1tcIkF1dGhvcml6YXRpb25cIl0gPSBgQmFzaWMgJHtCdWZmZXIuZnJvbShcbiAgICAgICAgdGhpcy5jcmVkZW50aWFscy5hcGlLZXkgKyBcIjpcIiArIHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0XG4gICAgICApLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWA7XG4gICAgfVxuXG4gICAgdGhpcy5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShwYXJhbXMpLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgfSxcbiAgICAgIFwiUE9TVFwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgcG9zdFVzZVF1ZXJ5U3RyaW5nKHBhdGgsIHBhcmFtcywgY2FsbGJhY2ssIHVzZUp3dCkge1xuICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICBpZiAoIXVzZUp3dCkge1xuICAgICAgcGFyYW1zW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5O1xuICAgICAgcGFyYW1zW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIHBhdGggPSBwYXRoICsgXCI/XCIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocGFyYW1zKTtcblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgIH0sXG4gICAgICBcIlBPU1RcIixcbiAgICAgIGNhbGxiYWNrXG4gICAgKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBIdHRwQ2xpZW50O1xuIl19