"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _index = _interopRequireDefault(require("./index"));

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Provides access to the `users` endpoint.
 */
class Users {
  static get PATH() {
    return "/beta/users";
  }

  static get BETA2_PATH() {
    return "/beta2/users";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Additional Users options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
  }
  /**
   * Create a new user.
   *
   * @param {Object} params - Parameters used when creating the user. See https://ea.developer.nexmo.com/api/conversation#create-a-user for more information.
   * @param {function} callback - function to be called when the request completes.
   */


  create(params, callback) {
    params = JSON.stringify(params);
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: Users.PATH,
      method: "POST",
      body: params,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer ".concat(this.creds.generateJwt())
      }
    };
    this.options.httpClient.request(config, callback);
  }
  /**
   * Get an existing user.
   *
   * @param {string|object} query - The unique identifier for the user to retrieve
   *               or a set of filter parameters for the query. For more information
   *               see https://ea.developer.nexmo.com/api/conversation#retrieve-all-users
   * @param {function} callback - function to be called when the request completes.
   */


  get(query, callback) {
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: _Utils.default.createPathWithQuery(Users.BETA2_PATH, query),
      method: "GET",
      body: undefined,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer ".concat(this.creds.generateJwt())
      }
    };
    this.options.httpClient.request(config, callback);
  }
  /**
   * Get next page of users or conversations for a user.
   *
   * @param {object} response - The response from a paginated users or conversations list
   *               see https://ea.developer.nexmo.com/api/conversation#retrieve-all-users
   * @param {function} callback - function to be called when the request completes.
   */


  next(response, callback) {
    if (response._links.next) {
      var userId = response._links.next.href.match(/USR-[^/]*/g);

      if (userId) {
        this.getConversations(userId[0], _Utils.default.getQuery(response._links.next.href), callback);
      } else {
        this.get(_Utils.default.getQuery(response._links.next.href), callback);
      }
    } else {
      var error = new Error("The response doesn't have a next page.");
      callback(error, null);
    }
  }
  /**
   * Get previous page of users or conversations for a user.
   *
   * @param {object} response - The response from a paginated users or conversations list
   *               see https://ea.developer.nexmo.com/api/conversation#retrieve-all-users
   * @param {function} callback - function to be called when the request completes.
   */


  prev(response, callback) {
    if (response._links.prev) {
      var userId = response._links.prev.href.match(/USR-[^/]*/g);

      if (userId) {
        this.getConversations(userId[0], _Utils.default.getQuery(response._links.prev.href), callback);
      } else {
        this.get(_Utils.default.getQuery(response._links.prev.href), callback);
      }
    } else {
      var error = new Error("The response doesn't have a previous page.");
      callback(error, null);
    }
  }
  /**
   * Get an conversations for an existing user.
   *
   * @param {string} userId - The unique identifier for the user to retrieve conversations for
   * @param {function} callback - function to be called when the request completes.
   */


  getConversations(userId, query, callback) {
    // backwards compatibility to 2.5.4-beta-1. Remove for 3.0.0
    if (typeof query === "function") {
      callback = query;
      query = {};
    }

    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: _Utils.default.createPathWithQuery("".concat(Users.BETA2_PATH, "/").concat(userId, "/conversations"), query),
      method: "GET",
      body: undefined,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer ".concat(this.creds.generateJwt())
      }
    };
    this.options.httpClient.request(config, callback);
  }
  /**
   * Update an existing user.
   *
   * @param {string} userId - The unique identifier for the user to update.
   * @param {Object} params - Parameters used when updating the conversation.
   * @param {function} callback - function to be called when the request completes.
   */


  update(userId, params, callback) {
    params = JSON.stringify(params);
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: "".concat(Users.PATH, "/").concat(userId),
      method: "PUT",
      body: params,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer ".concat(this.creds.generateJwt())
      }
    };
    this.options.httpClient.request(config, callback);
  }
  /**
   * Deleta an existing user.
   *
   * @param {string} userId - The unique identifier for the user to delete.
   * @param {function} callback - function to be called when the request completes.
   */


  delete(userId, callback) {
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: "".concat(Users.PATH, "/").concat(userId),
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer ".concat(this.creds.generateJwt())
      }
    };
    this.options.httpClient.request(config, callback);
  }

}

var _default = Users;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Vc2Vycy5qcyJdLCJuYW1lcyI6WyJVc2VycyIsIlBBVEgiLCJCRVRBMl9QQVRIIiwiY29uc3RydWN0b3IiLCJjcmVkZW50aWFscyIsIm9wdGlvbnMiLCJjcmVkcyIsImNyZWF0ZSIsInBhcmFtcyIsImNhbGxiYWNrIiwiSlNPTiIsInN0cmluZ2lmeSIsImNvbmZpZyIsImhvc3QiLCJhcGlIb3N0IiwicGF0aCIsIm1ldGhvZCIsImJvZHkiLCJoZWFkZXJzIiwiQXV0aG9yaXphdGlvbiIsImdlbmVyYXRlSnd0IiwiaHR0cENsaWVudCIsInJlcXVlc3QiLCJnZXQiLCJxdWVyeSIsIlV0aWxzIiwiY3JlYXRlUGF0aFdpdGhRdWVyeSIsInVuZGVmaW5lZCIsIm5leHQiLCJyZXNwb25zZSIsIl9saW5rcyIsInVzZXJJZCIsImhyZWYiLCJtYXRjaCIsImdldENvbnZlcnNhdGlvbnMiLCJnZXRRdWVyeSIsImVycm9yIiwiRXJyb3IiLCJwcmV2IiwidXBkYXRlIiwiZGVsZXRlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOztBQUVBOzs7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsTUFBTUEsS0FBTixDQUFZO0FBQ0ssYUFBSkMsSUFBSSxHQUFHO0FBQ2hCLFdBQU8sYUFBUDtBQUNEOztBQUVvQixhQUFWQyxVQUFVLEdBQUc7QUFDdEIsV0FBTyxjQUFQO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQUNFQyxFQUFBQSxXQUFXLENBQUNDLFdBQUQsRUFBNEI7QUFBQSxRQUFkQyxPQUFjLHVFQUFKLEVBQUk7QUFDckMsU0FBS0MsS0FBTCxHQUFhRixXQUFiO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFmO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQUNFRSxFQUFBQSxNQUFNLENBQUNDLE1BQUQsRUFBU0MsUUFBVCxFQUFtQjtBQUN2QkQsSUFBQUEsTUFBTSxHQUFHRSxJQUFJLENBQUNDLFNBQUwsQ0FBZUgs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Uzs7ZUE0TEdULEsiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IG5leG1vIGZyb20gXCIuL2luZGV4XCI7XG5cbmltcG9ydCBVdGlscyBmcm9tIFwiLi9VdGlsc1wiO1xuXG4vKipcbiAqIFByb3ZpZGVzIGFjY2VzcyB0byB0aGUgYHVzZXJzYCBlbmRwb2ludC5cbiAqL1xuY2xhc3MgVXNlcnMge1xuICBzdGF0aWMgZ2V0IFBBVEgoKSB7XG4gICAgcmV0dXJuIFwiL2JldGEvdXNlcnNcIjtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgQkVUQTJfUEFUSCgpIHtcbiAgICByZXR1cm4gXCIvYmV0YTIvdXNlcnNcIjtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge0NyZWRlbnRpYWxzfSBjcmVkZW50aWFsc1xuICAgKiAgICBjcmVkZW50aWFscyB0byBiZSB1c2VkIHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgQVBJLlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiAgICBBZGRpdGlvbmFsIFVzZXJzIG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IHVzZXIuXG4gICAqXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgLSBQYXJhbWV0ZXJzIHVzZWQgd2hlbiBjcmVhdGluZyB0aGUgdXNlci4gU2VlIGh0dHBzOi8vZWEuZGV2ZWxvcGVyLm5leG1vLmNvbS9hcGkvY29udmVyc2F0aW9uI2NyZWF0ZS1hLXVzZXIgZm9yIG1vcmUgaW5mb3JtYXRpb24uXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdGhlIHJlcXVlc3QgY29tcGxldGVzLlxuICAgKi9cbiAgY3JlYXRlKHBhcmFtcywgY2FsbGJhY2spIHtcbiAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpO1xuXG4gICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgcGF0aDogVXNlcnMuUEFUSCxcbiAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICBib2R5OiBwYXJhbXMsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy5jcmVkcy5nZW5lcmF0ZUp3dCgpfWAsXG4gICAgICB9LFxuICAgIH07XG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChjb25maWcsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gZXhpc3RpbmcgdXNlci5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBxdWVyeSAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHVzZXIgdG8gcmV0cmlldmVcbiAgICogICAgICAgICAgICAgICBvciBhIHNldCBvZiBmaWx0ZXIgcGFyYW1ldGVycyBmb3IgdGhlIHF1ZXJ5LiBGb3IgbW9yZSBpbmZvcm1hdGlvblxuICAgKiAgICAgICAgICAgICAgIHNlZSBodHRwczovL2VhLmRldmVsb3Blci5uZXhtby5jb20vYXBpL2NvbnZlcnNhdGlvbiNyZXRyaWV2ZS1hbGwtdXNlcnNcbiAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB0aGUgcmVxdWVzdCBjb21wbGV0ZXMuXG4gICAqL1xuICBnZXQocXVlcnksIGNhbGxiYWNrKSB7XG4gICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShVc2Vycy5CRVRBMl9QQVRILCBxdWVyeSksXG4gICAgICBtZXRob2Q6IFwiR0VUXCIsXG4gICAgICBib2R5OiB1bmRlZmluZWQsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy5jcmVkcy5nZW5lcmF0ZUp3dCgpfWAsXG4gICAgICB9LFxuICAgIH07XG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChjb25maWcsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbmV4dCBwYWdlIG9mIHVzZXJzIG9yIGNvbnZlcnNhdGlvbnMgZm9yIGEgdXNlci5cbiAgICpcbiAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIGZyb20gYSBwYWdpbmF0ZWQgdXNlcnMgb3IgY29udmVyc2F0aW9ucyBsaXN0XG4gICAqICAgICAgICAgICAgICAgc2VlIGh0dHBzOi8vZWEuZGV2ZWxvcGVyLm5leG1vLmNvbS9hcGkvY29udmVyc2F0aW9uI3JldHJpZXZlLWFsbC11c2Vyc1xuICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IGNvbXBsZXRlcy5cbiAgICovXG4gIG5leHQocmVzcG9uc2UsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHJlc3BvbnNlLl9saW5rcy5uZXh0KSB7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXNwb25zZS5fbGlua3MubmV4dC5ocmVmLm1hdGNoKC9VU1ItW14vXSovZyk7XG4gICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgIHRoaXMuZ2V0Q29udmVyc2F0aW9ucyhcbiAgICAgICAgICB1c2VySWRbMF0sXG4gICAgICAgICAgVXRpbHMuZ2V0UXVlcnkocmVzcG9uc2UuX2xpbmtzLm5leHQuaHJlZiksXG4gICAgICAgICAgY2FsbGJhY2tcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZ2V0KFV0aWxzLmdldFF1ZXJ5KHJlc3BvbnNlLl9saW5rcy5uZXh0LmhyZWYpLCBjYWxsYmFjayk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKFwiVGhlIHJlc3BvbnNlIGRvZXNuJ3QgaGF2ZSBhIG5leHQgcGFnZS5cIik7XG4gICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBwcmV2aW91cyBwYWdlIG9mIHVzZXJzIG9yIGNvbnZlcnNhdGlvbnMgZm9yIGEgdXNlci5cbiAgICpcbiAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIGZyb20gYSBwYWdpbmF0ZWQgdXNlcnMgb3IgY29udmVyc2F0aW9ucyBsaXN0XG4gICAqICAgICAgICAgICAgICAgc2VlIGh0dHBzOi8vZWEuZGV2ZWxvcGVyLm5leG1vLmNvbS9hcGkvY29udmVyc2F0aW9uI3JldHJpZXZlLWFsbC11c2Vyc1xuICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IGNvbXBsZXRlcy5cbiAgICovXG4gIHByZXYocmVzcG9uc2UsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHJlc3BvbnNlLl9saW5rcy5wcmV2KSB7XG4gICAgICBjb25zdCB1c2VySWQgPSByZXNwb25zZS5fbGlua3MucHJldi5ocmVmLm1hdGNoKC9VU1ItW14vXSovZyk7XG4gICAgICBpZiAodXNlcklkKSB7XG4gICAgICAgIHRoaXMuZ2V0Q29udmVyc2F0aW9ucyhcbiAgICAgICAgICB1c2VySWRbMF0sXG4gICAgICAgICAgVXRpbHMuZ2V0UXVlcnkocmVzcG9uc2UuX2xpbmtzLnByZXYuaHJlZiksXG4gICAgICAgICAgY2FsbGJhY2tcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZ2V0KFV0aWxzLmdldFF1ZXJ5KHJlc3BvbnNlLl9saW5rcy5wcmV2LmhyZWYpLCBjYWxsYmFjayk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKFwiVGhlIHJlc3BvbnNlIGRvZXNuJ3QgaGF2ZSBhIHByZXZpb3VzIHBhZ2UuXCIpO1xuICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gY29udmVyc2F0aW9ucyBmb3IgYW4gZXhpc3RpbmcgdXNlci5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHVzZXIgdG8gcmV0cmlldmUgY29udmVyc2F0aW9ucyBmb3JcbiAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB0aGUgcmVxdWVzdCBjb21wbGV0ZXMuXG4gICAqL1xuICBnZXRDb252ZXJzYXRpb25zKHVzZXJJZCwgcXVlcnksIGNhbGxiYWNrKSB7XG4gICAgLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgdG8gMi41LjQtYmV0YS0xLiBSZW1vdmUgZm9yIDMuMC4wXG4gICAgaWYgKHR5cGVvZiBxdWVyeSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjYWxsYmFjayA9IHF1ZXJ5O1xuICAgICAgcXVlcnkgPSB7fTtcbiAgICB9XG5cbiAgICB2YXIgY29uZmlnID0ge1xuICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KFxuICAgICAgICBgJHtVc2Vycy5CRVRBMl9QQVRIfS8ke3VzZXJJZH0vY29udmVyc2F0aW9uc2AsXG4gICAgICAgIHF1ZXJ5XG4gICAgICApLFxuICAgICAgbWV0aG9kOiBcIkdFVFwiLFxuICAgICAgYm9keTogdW5kZWZpbmVkLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuY3JlZHMuZ2VuZXJhdGVKd3QoKX1gLFxuICAgICAgfSxcbiAgICB9O1xuICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoY29uZmlnLCBjYWxsYmFjayk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGFuIGV4aXN0aW5nIHVzZXIuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1c2VySWQgLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgZm9yIHRoZSB1c2VyIHRvIHVwZGF0ZS5cbiAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyAtIFBhcmFtZXRlcnMgdXNlZCB3aGVuIHVwZGF0aW5nIHRoZSBjb252ZXJzYXRpb24uXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdGhlIHJlcXVlc3QgY29tcGxldGVzLlxuICAgKi9cbiAgdXBkYXRlKHVzZXJJZCwgcGFyYW1zLCBjYWxsYmFjaykge1xuICAgIHBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7XG5cbiAgICB2YXIgY29uZmlnID0ge1xuICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICBwYXRoOiBgJHtVc2Vycy5QQVRIfS8ke3VzZXJJZH1gLFxuICAgICAgbWV0aG9kOiBcIlBVVFwiLFxuICAgICAgYm9keTogcGFyYW1zLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuY3JlZHMuZ2VuZXJhdGVKd3QoKX1gLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChjb25maWcsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGEgYW4gZXhpc3RpbmcgdXNlci5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHVzZXJJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIHVzZXIgdG8gZGVsZXRlLlxuICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IGNvbXBsZXRlcy5cbiAgICovXG4gIGRlbGV0ZSh1c2VySWQsIGNhbGxiYWNrKSB7XG4gICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgcGF0aDogYCR7VXNlcnMuUEFUSH0vJHt1c2VySWR9YCxcbiAgICAgIG1ldGhvZDogXCJERUxFVEVcIixcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmNyZWRzLmdlbmVyYXRlSnd0KCl9YCxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoY29uZmlnLCBjYWxsYmFjayk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVXNlcnM7XG4iXX0=