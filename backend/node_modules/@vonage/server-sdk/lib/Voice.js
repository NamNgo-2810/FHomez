"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Voice {
  static get ERROR_MESSAGES() {
    return {
      to: "Invalid to address",
      msg: "Invalid Text Message",
      maxDigits: "Invalid max digits for TTS prompt",
      byeText: "Invalid bye text for TTS prompt",
      pinCode: "Invalid pin code for TTS confirm",
      failedText: "Invalid failed text for TTS confirm",
      answerUrl: "Invalid answer URL for call"
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition  options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
  }

  _sendVoiceMessage(endpoint, data, callback) {
    if (!data.to) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.to));
    } else {
      data["api_key"] = this.creds.apiKey;
      data["api_secret"] = this.creds.apiSecret;
      this.options.logger.info("sending TTS message to " + data.to + " with message " + data.text);
      this.options.httpClient.request({
        host: endpoint.host,
        path: _Utils.default.createPathWithQuery(endpoint.path, data)
      }, "POST", (err, apiResponse) => {
        if (!err && apiResponse.status && apiResponse.status > 0) {
          _Utils.default.sendError(callback, new Error(apiResponse["error-text"]), apiResponse);
        } else {
          if (callback) callback(err, apiResponse);
        }
      });
    }
  }
  /**
   * TODO: document
   */


  sendTTSMessage(recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  sendTTSPromptWithCapture(recipient, message, maxDigits, byeText, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else if (!maxDigits || isNaN(maxDigits) || maxDigits.length > 16) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.maxDigits));
    } else if (!byeText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.byeText));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;
      opts["max_digits"] = maxDigits;
      opts["bye_text"] = byeText;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts-prompt/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  sendTTSPromptWithConfirm(recipient, message, maxDigits, pinCode, byeText, failedText, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else if (!maxDigits || isNaN(maxDigits) || maxDigits.length > 16) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.maxDigits));
    } else if (!pinCode || pinCode.length !== maxDigits) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.pinCode));
    } else if (!byeText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.byeText));
    } else if (!failedText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.failedText));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;
      opts["max_digits"] = maxDigits;
      opts["pin_code"] = pinCode;
      opts["bye_text"] = byeText;
      opts["failed_text"] = failedText;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts-prompt/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  call(recipient, answerUrl, opts, callback) {
    if (!answerUrl) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.answerUrl));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["answer_url"] = answerUrl;

      this._sendVoiceMessage({
        host: this.options.restHost || "rest.nexmo.com",
        path: "/call/json"
      }, opts, callback);
    }
  }

}

var _default = Voice;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Wb2ljZS5qcyJdLCJuYW1lcyI6WyJWb2ljZSIsIkVSUk9SX01FU1NBR0VTIiwidG8iLCJtc2ciLCJtYXhEaWdpdHMiLCJieWVUZXh0IiwicGluQ29kZSIsImZhaWxlZFRleHQiLCJhbnN3ZXJVcmwiLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiX3NlbmRWb2ljZU1lc3NhZ2UiLCJlbmRwb2ludCIsImRhdGEiLCJjYWxsYmFjayIsIlV0aWxzIiwic2VuZEVycm9yIiwiRXJyb3IiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJsb2dnZXIiLCJpbmZvIiwidGV4dCIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwiaG9zdCIsInBhdGgiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwiZXJyIiwiYXBpUmVzcG9uc2UiLCJzdGF0dXMiLCJzZW5kVFRTTWVzc2FnZSIsInJlY2lwaWVudCIsIm1lc3NhZ2UiLCJvcHRzIiwiYXBpSG9zdCIsInNlbmRUVFNQcm9tcHRXaXRoQ2FwdHVyZSIsImlzTmFOIiwibGVuZ3RoIiwic2VuZFRUU1Byb21wdFdpdGhDb25maXJtIiwiY2FsbCIsInJlc3RIb3N0Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOzs7O0FBRUEsTUFBTUEsS0FBTixDQUFZO0FBQ2UsYUFBZEMsY0FBYyxHQUFHO0FBQzFCLFdBQU87QUFDTEMsTUFBQUEsRUFBRSxFQUFFLG9CQURDO0FBRUxDLE1BQUFBLEdBQUcsRUFBRSxzQkFGQTtBQUdMQyxNQUFBQSxTQUFTLEVBQUUsbUNBSE47QUFJTEMsTUFBQUEsT0FBTyxFQUFFLGlDQUpKO0FBS0xDLE1BQUFBLE9BQU8sRUFBRSxrQ0FMSjtBQU1MQyxNQUFBQSxVQUFVLEVBQUUscUNBTlA7QUFPTEMsTUFBQUEsU0FBUyxFQUFFO0FBUE4sS0FBUDtBQVNEO0FBQ0Q7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDRUMsRUFBQUEsV0FBVyxDQUFDQyxXQUFELEVBQTRCO0FBQUEsUUFBZEMsT0FBYyx1RUFBSixFQUFJO0FBQ3JDLFNBQUtDLEtBQUwsR0FBYUYsV0FBYjtBQUNBLFNBQUtDLE9BQUwsR0FBZUEsT0FBZjtBQUNEOztBQUVERSxFQUFBQSxpQkFBaUIsQ0FBQ0MsUUFBRCxFQUFXQyxJQUFYLEVBQWlCQyxRQUFqQixFQUEyQjtBQUMxQyxRQUFJLENBQUNELElBQUksQ0FBQ2IsRUFBVixFQUFjO0FBQ1plLHFCQUFNQyxTQUFOLENBQWdCRixRQUFoQixFQUEwQixJQUFJRyxLQUFKLENBQVVuQixLQUFLLENBQUNDLGNBQU4sQ0FBcUJDLEVBQS9CLENBQTFCO0FBQ0QsS0FGRCxNQUVPO0FBQ0xhLE1BQUFBLElBQUksQ0FBQyxTQUFELENBQUosR0FBa0IsS0FBS0gsS0FBTCxDQUFXUSxNQUE3QjtBQUNBTCxNQUFBQSxJQUFJLENBQUMsWUFBRCxDQUFKLEdBQXFCLEtBQUtILEtBQUwsQ0FBV1MsU0FBaEM7QUFDQSxXQUFLVixPQUFMLENBQWFXLE1BQWIsQ0FBb0JDLElBQXBCLENBQ0UsNEJBQTRCUixJQUFJLENBQUNiLEVBQWpDLEdBQXNDLGdCQUF0QyxHQUF5RGEsSUFBSSxDQUFDUyxJQURoRTtBQUdBLFdBQUtiLE9BQUwsQ0FBYWMsVUFBYixDQUF3QkMsT0FBeEIsQ0FDRTtBQUNFQyxRQUFBQSxJQUFJLEVBQUViLFFBQVEsQ0FBQ2EsSUFEakI7QUFFRUMsUUFBQUEsSUFBSSxFQUFFWCxlQUFNWSxtQkFBTixDQUEwQmYsUUFBUSxDQUFDYyxJQUFuQyxFQUF5Q2IsSUFBekM7QUFGUixPQURGLEVBS0UsTUFMRixFQU1FLENBQUNlLEdBQUQsRUFBTUMsV0FBTixLQUFzQjtBQUNwQixZQUFJLENBQUNELEdBQUQsSUFBUUMsV0FBVyxDQUFDQyxNQUFwQixJQUE4QkQsV0FBVyxDQUFDQyxNQUFaLEdBQXFCLENBQXZELEVBQTBEO0FBQ3hEZix5QkFBTUMsU0FBTixDQUNFRixRQURGLEVBRUUsSUFBSUcsS0FBSixDQUFVWSxXQUFXLENBQUMsWUFBRCxDQUFyQixDQUZGLEVBR0VBLFdBSEY7QUFLRCxTQU5ELE1BTU87QUFDTCxjQUFJZixRQUFKLEVBQWNBLFFBQVEsQ0FBQ2MsR0FBRCxFQUFNQyxXQUFOLENBQVI7QUFDZjtBQUNGLE9BaEJIO0FBa0JEO0FBQ0Y7QUFFRDtBQUNGO0FBQ0E7OztBQUNFRSxFQUFBQSxjQUFjLENBQUNDLFNBQUQsRUFBWUMsT0FBWixFQUFxQkMsSUFBckIsRUFBMkJwQixRQUEzQixFQUFxQztBQUNqRCxRQUFJLENBQUNtQixPQUFMLEVBQWM7QUFDWmxCLHFCQUFNQyxTQUFOLENBQWdCRixRQUFoQixFQUEwQixJQUFJRyxLQUFKLENBQVVuQixLQUFLLENBQUNDLGNBQU4sQ0FBcUJFLEdBQS9CLENBQTFCO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsVUFBSSxDQUFDaUMsSUFBTCxFQUFXO0FBQ1RBLFFBQUFBLElBQUksR0FBRyxFQUFQO0FBQ0Q7O0FBQ0RBLE1BQUFBLElBQUksQ0FBQyxJQUFELENBQUosR0FBYUYsU0FBYjtBQUNBRSxNQUFBQSxJQUFJLENBQUMsTUFBRCxDQUFKLEdBQWVELE9BQWY7O0FBQ0EsV0FBS3RCLGlCQUFMLENBQ0U7QUFDRWMsUUFBQUEsSUFBSSxFQUFFLEtBQUtoQixPQUFMLENBQWEwQixPQUFiLElBQXdCLGVBRGhDO0FBRUVULFFBQUFBLElBQUksRUFBRTtBQUZSLE9BREYsRUFLRVEsSUFMRixFQU1FcEIsUUFORjtBQVFEO0FBQ0Y7QUFFRDtBQUNGO0FBQ0E7OztBQUNFc0IsRUFBQUEsd0JBQXdCLENBQ3RCSixTQURzQixFQUV0QkMsT0FGc0IsRUFHdEIvQixTQUhzQixFQUl0QkMsT0FKc0IsRUFLdEIrQixJQUxzQixFQU10QnBCLFFBTnNCLEVBT3RCO0FBQ0EsUUFBSSxDQUFDbUIsT0FBTCxFQUFjO0FBQ1psQixxQkFBTUMsU0FBTixDQUFnQkYsUUFBaEIsRUFBMEIsSUFBSUcsS0FBSixDQUFVbkIsS0FBSyxDQUFDQyxjQUFOLENBQXFCRSxHQUEvQixDQUExQjtBQUNELEtBRkQsTUFFTyxJQUFJLENBQUNDLFNBQUQsSUFBY21DLEtBQUssQ0FBQ25DLFNBQUQsQ0FBbkIsSUFBa0NBLFNBQVMsQ0FBQ29DLE1BQVYsR0FBbUIsRUFBekQsRUFBNkQ7QUFDbEV2QixxQkFBTUMsU0FBTixDQUFnQkYsUUFBaEIsRUFBMEIsSUFBSUcsS0FBSixDQUFVbkIsS0FBSyxDQUFDQyxjQUFOLENBQXFCRyxTQUEvQixDQUExQjtBQUNELEtBRk0sTUFFQSxJQUFJLENBQUNDLE9BQUwsRUFBYztBQUNuQlkscUJBQU1DLFNBQU4sQ0FBZ0JGLFFBQWhCLEVBQTBCLElBQUlHLEtBQUosQ0FBVW5CLEtBQUssQ0FBQ0MsY0FBTixDQUFxQkksT0FBL0IsQ0FBMUI7QUFDRCxLQUZNLE1BRUE7QUFDTCxVQUFJLENBQUMrQixJQUFMLEVBQVc7QUFDVEEsUUFBQUEsSUFBSSxHQUFHLEVBQVA7QUFDRDs7QUFDREEsTUFBQUEsSUFBSSxDQUFDLElBQUQsQ0FBSixHQUFhRixTQUFiO0FBQ0FFLE1BQUFBLElBQUksQ0FBQyxNQUFELENBQUosR0FBZUQsT0FBZjtBQUNBQyxNQUFBQSxJQUFJLENBQUMsWUFBRCxDQUFKLEdBQXFCaEMsU0FBckI7QUFDQWdDLE1BQUFBLElBQUksQ0FBQyxVQUFELENBQUosR0FBbUIvQixPQUFuQjs7QUFDQSxXQUFLUSxpQkFBTCxDQUNFO0FBQ0VjLFFBQUFBLElBQUksRUFBRSxLQUFLaEIsT0FBTCxDQUFhMEIsT0FBYixJQUF3QixlQURoQztBQUVFVCxRQUFBQSxJQUFJLEVBQUU7QUFGUixPQURGLEVBS0VRLElBTEYsRUFNRXBCLFFBTkY7QUFRRDtBQUNGO0FBRUQ7QUFDRjtBQUNBOzs7QUFDRXlCLEVBQUFBLHdCQUF3QixDQUN0QlAsU0FEc0IsRUFFdEJDLE9BRnNCLEVBR3RCL0IsU0FIc0IsRUFJdEJFLE9BSnNCLEVBS3RCRCxPQUxzQixFQU10QkUsVUFOc0IsRUFPdEI2QixJQVBzQixFQVF0QnBCLFFBUnNCLEVBU3RCO0FBQ0EsUUFBSSxDQUFDbUIsT0FBTCxFQUFjO0FBQ1psQixxQkFBTUMsU0FBTixDQUFnQkYsUUFBaEIsRUFBMEIsSUFBSUcsS0FBSixDQUFVbkIsS0FBSyxDQUFDQyxjQUFOLENBQXFCRSxHQUEvQixDQUExQjtBQUNELEtBRkQsTUFFTyxJQUFJLENBQUNDLFNBQUQsSUFBY21DLEtBQUssQ0FBQ25DLFNBQUQsQ0FBbkIsSUFBa0NBLFNBQVMsQ0FBQ29DLE1BQVYsR0FBbUIsRUFBekQsRUFBNkQ7QUFDbEV2QixxQkFBTUMsU0FBTixDQUFnQkYsUUFBaEIsRUFBMEIsSUFBSUcsS0FBSixDQUFVbkIsS0FBSyxDQUFDQyxjQUFOLENBQXFCRyxTQUEvQixDQUExQjtBQUNELEtBRk0sTUFFQSxJQUFJLENBQUNFLE9BQUQsSUFBWUEsT0FBTyxDQUFDa0MsTUFBUixLQUFtQnBDLFNBQW5DLEVBQThDO0FBQ25EYSxxQkFBTUMsU0FBTixDQUFnQkYsUUFBaEIsRUFBMEIsSUFBSUcsS0FBSixDQUFVbkIsS0FBSyxDQUFDQyxjQUFOLENBQXFCSyxPQUEvQixDQUExQjtBQUNELEtBRk0sTUFFQSxJQUFJLENBQUNELE9BQUwsRUFBYztBQUNuQlkscUJBQU1DLFNBQU4sQ0FBZ0JGLFFBQWhCLEVBQTBCLElBQUlHLEtBQUosQ0FBVW5CLEtBQUssQ0FBQ0MsY0FBTixDQUFxQkksT0FBL0IsQ0FBMUI7QUFDRCxLQUZNLE1BRUEsSUFBSSxDQUFDRSxVQUFMLEVBQWlCO0FBQ3RCVSxxQkFBTUMsU0FBTixDQUFnQkYsUUFBaEIsRUFBMEIsSUFBSUcsS0FBSixDQUFVbkIsS0FBSyxDQUFDQyxjQUFOLENBQXFCTSxVQUEvQixDQUExQjtBQUNELEtBRk0sTUFFQTtBQUNMLFVBQUksQ0FBQzZCLElBQUwsRUFBVztBQUNUQSxRQUFBQSxJQUFJLEdBQUcsRUFBUDtBQUNEOztBQUNEQSxNQUFBQSxJQUFJLENBQUMsSUFBRCxDQUFKLEdBQWFGLFNBQWI7QUFDQUUsTUFBQUEsSUFBSSxDQUFDLE1BQUQsQ0FBSixHQUFlRCxPQUFmO0FBQ0FDLE1BQUFBLElBQUksQ0FBQyxZQUFELENBQUosR0FBcUJoQyxTQUFyQjtBQUNBZ0MsTUFBQUEsSUFBSSxDQUFDLFVBQUQsQ0FBSixHQUFtQjlCLE9BQW5CO0FBQ0E4QixNQUFBQSxJQUFJLENBQUMsVUFBRCxDQUFKLEdBQW1CL0IsT0FBbkI7QUFDQStCLE1BQUFBLElBQUksQ0FBQyxhQUFELENBQUosR0FBc0I3QixVQUF0Qjs7QUFDQSxXQUFLTSxpQkFBTCxDQUNFO0FBQ0VjLFFBQUFBLElBQUksRUFBRSxLQUFLaEIsT0FBTCxDQUFhMEIsT0FBYixJQUF3QixlQURoQztBQUVFVCxRQUFBQSxJQUFJLEVBQUU7QUFGUixPQURGLEVBS0VRLElBTEYsRUFNRXBCLFFBTkY7QUFRRDtBQUNGO0FBRUQ7QUFDRjtBQUNBOzs7QUFDRTBCLEVBQUFBLElBQUksQ0FBQ1IsU0FBRCxFQUFZMUIsU0FBWixFQUF1QjRCLElBQXZCLEVBQTZCcEIsUUFBN0IsRUFBdUM7QUFDekMsUUFBSSxDQUFDUixTQUFMLEVBQWdCO0FBQ2RTLHFCQUFNQyxTQUFOLENBQWdCRixRQUFoQixFQUEwQixJQUFJRyxLQUFKLENBQVVuQixLQUFLLENBQUNDLGNBQU4sQ0FBcUJPLFNBQS9CLENBQTFCO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsVUFBSSxDQUFDNEIsSUFBTCxFQUFXO0FBQ1RBLFFBQUFBLElBQUksR0FBRyxFQUFQO0FBQ0Q7O0FBQ0RBLE1BQUFBLElBQUksQ0FBQyxJQUFELENBQUosR0FBYUYsU0FBYjtBQUNBRSxNQUFBQSxJQUFJLENBQUMsWUFBRCxDQUFKLEdBQXFCNUIsU0FBckI7O0FBQ0EsV0FBS0ssaUJBQUwsQ0FDRTtBQUNFYyxRQUFBQSxJQUFJLEVBQUUsS0FBS2hCLE9BQUwsQ0FBYWdDLFFBQWIsSUFBeUIsZ0JBRGpDO0FBRUVmLFFBQUFBLElBQUksRUFBRTtBQUZSLE9BREYsRUFLRVEsSUFMRixFQU1FcEIsUUFORjtBQVFEO0FBQ0Y7O0FBakxTOztlQW9MR2hCLEsiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL1V0aWxzXCI7XG5cbmNsYXNzIFZvaWNlIHtcbiAgc3RhdGljIGdldCBFUlJPUl9NRVNTQUdFUygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdG86IFwiSW52YWxpZCB0byBhZGRyZXNzXCIsXG4gICAgICBtc2c6IFwiSW52YWxpZCBUZXh0IE1lc3NhZ2VcIixcbiAgICAgIG1heERpZ2l0czogXCJJbnZhbGlkIG1heCBkaWdpdHMgZm9yIFRUUyBwcm9tcHRcIixcbiAgICAgIGJ5ZVRleHQ6IFwiSW52YWxpZCBieWUgdGV4dCBmb3IgVFRTIHByb21wdFwiLFxuICAgICAgcGluQ29kZTogXCJJbnZhbGlkIHBpbiBjb2RlIGZvciBUVFMgY29uZmlybVwiLFxuICAgICAgZmFpbGVkVGV4dDogXCJJbnZhbGlkIGZhaWxlZCB0ZXh0IGZvciBUVFMgY29uZmlybVwiLFxuICAgICAgYW5zd2VyVXJsOiBcIkludmFsaWQgYW5zd2VyIFVSTCBmb3IgY2FsbFwiLFxuICAgIH07XG4gIH1cbiAgLyoqXG4gICAqIEBwYXJhbSB7Q3JlZGVudGlhbHN9IGNyZWRlbnRpYWxzXG4gICAqICAgIGNyZWRlbnRpYWxzIHRvIGJlIHVzZWQgd2hlbiBpbnRlcmFjdGluZyB3aXRoIHRoZSBBUEkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gICAqICAgIEFkZGl0aW9uICBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoY3JlZGVudGlhbHMsIG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuY3JlZHMgPSBjcmVkZW50aWFscztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgX3NlbmRWb2ljZU1lc3NhZ2UoZW5kcG9pbnQsIGRhdGEsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFkYXRhLnRvKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy50bykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkYXRhW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZHMuYXBpS2V5O1xuICAgICAgZGF0YVtcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRzLmFwaVNlY3JldDtcbiAgICAgIHRoaXMub3B0aW9ucy5sb2dnZXIuaW5mbyhcbiAgICAgICAgXCJzZW5kaW5nIFRUUyBtZXNzYWdlIHRvIFwiICsgZGF0YS50byArIFwiIHdpdGggbWVzc2FnZSBcIiArIGRhdGEudGV4dFxuICAgICAgKTtcbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiBlbmRwb2ludC5ob3N0LFxuICAgICAgICAgIHBhdGg6IFV0aWxzLmNyZWF0ZVBhdGhXaXRoUXVlcnkoZW5kcG9pbnQucGF0aCwgZGF0YSksXG4gICAgICAgIH0sXG4gICAgICAgIFwiUE9TVFwiLFxuICAgICAgICAoZXJyLCBhcGlSZXNwb25zZSkgPT4ge1xuICAgICAgICAgIGlmICghZXJyICYmIGFwaVJlc3BvbnNlLnN0YXR1cyAmJiBhcGlSZXNwb25zZS5zdGF0dXMgPiAwKSB7XG4gICAgICAgICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgICAgICAgIGNhbGxiYWNrLFxuICAgICAgICAgICAgICBuZXcgRXJyb3IoYXBpUmVzcG9uc2VbXCJlcnJvci10ZXh0XCJdKSxcbiAgICAgICAgICAgICAgYXBpUmVzcG9uc2VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyLCBhcGlSZXNwb25zZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZFRUU01lc3NhZ2UocmVjaXBpZW50LCBtZXNzYWdlLCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMubXNnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghb3B0cykge1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widGV4dFwiXSA9IG1lc3NhZ2U7XG4gICAgICB0aGlzLl9zZW5kVm9pY2VNZXNzYWdlKFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogXCIvdHRzL2pzb25cIixcbiAgICAgICAgfSxcbiAgICAgICAgb3B0cyxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IHJlbW92ZSB3aXRoIG5leHQgbWFqb3IgdmVyc2lvbiwgQVBJIGlzIDQwNFxuICAgKi9cbiAgc2VuZFRUU1Byb21wdFdpdGhDYXB0dXJlKFxuICAgIHJlY2lwaWVudCxcbiAgICBtZXNzYWdlLFxuICAgIG1heERpZ2l0cyxcbiAgICBieWVUZXh0LFxuICAgIG9wdHMsXG4gICAgY2FsbGJhY2tcbiAgKSB7XG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5tc2cpKTtcbiAgICB9IGVsc2UgaWYgKCFtYXhEaWdpdHMgfHwgaXNOYU4obWF4RGlnaXRzKSB8fCBtYXhEaWdpdHMubGVuZ3RoID4gMTYpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLm1heERpZ2l0cykpO1xuICAgIH0gZWxzZSBpZiAoIWJ5ZVRleHQpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLmJ5ZVRleHQpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFvcHRzKSB7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0ZXh0XCJdID0gbWVzc2FnZTtcbiAgICAgIG9wdHNbXCJtYXhfZGlnaXRzXCJdID0gbWF4RGlnaXRzO1xuICAgICAgb3B0c1tcImJ5ZV90ZXh0XCJdID0gYnllVGV4dDtcbiAgICAgIHRoaXMuX3NlbmRWb2ljZU1lc3NhZ2UoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBcIi90dHMtcHJvbXB0L2pzb25cIixcbiAgICAgICAgfSxcbiAgICAgICAgb3B0cyxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IHJlbW92ZSB3aXRoIG5leHQgbWFqb3IgdmVyc2lvbiwgQVBJIGlzIDQwNFxuICAgKi9cbiAgc2VuZFRUU1Byb21wdFdpdGhDb25maXJtKFxuICAgIHJlY2lwaWVudCxcbiAgICBtZXNzYWdlLFxuICAgIG1heERpZ2l0cyxcbiAgICBwaW5Db2RlLFxuICAgIGJ5ZVRleHQsXG4gICAgZmFpbGVkVGV4dCxcbiAgICBvcHRzLFxuICAgIGNhbGxiYWNrXG4gICkge1xuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMubXNnKSk7XG4gICAgfSBlbHNlIGlmICghbWF4RGlnaXRzIHx8IGlzTmFOKG1heERpZ2l0cykgfHwgbWF4RGlnaXRzLmxlbmd0aCA+IDE2KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5tYXhEaWdpdHMpKTtcbiAgICB9IGVsc2UgaWYgKCFwaW5Db2RlIHx8IHBpbkNvZGUubGVuZ3RoICE9PSBtYXhEaWdpdHMpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLnBpbkNvZGUpKTtcbiAgICB9IGVsc2UgaWYgKCFieWVUZXh0KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5ieWVUZXh0KSk7XG4gICAgfSBlbHNlIGlmICghZmFpbGVkVGV4dCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMuZmFpbGVkVGV4dCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIW9wdHMpIHtcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInRleHRcIl0gPSBtZXNzYWdlO1xuICAgICAgb3B0c1tcIm1heF9kaWdpdHNcIl0gPSBtYXhEaWdpdHM7XG4gICAgICBvcHRzW1wicGluX2NvZGVcIl0gPSBwaW5Db2RlO1xuICAgICAgb3B0c1tcImJ5ZV90ZXh0XCJdID0gYnllVGV4dDtcbiAgICAgIG9wdHNbXCJmYWlsZWRfdGV4dFwiXSA9IGZhaWxlZFRleHQ7XG4gICAgICB0aGlzLl9zZW5kVm9pY2VNZXNzYWdlKFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogXCIvdHRzLXByb21wdC9qc29uXCIsXG4gICAgICAgIH0sXG4gICAgICAgIG9wdHMsXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiByZW1vdmUgd2l0aCBuZXh0IG1ham9yIHZlcnNpb24sIEFQSSBpcyA0MDRcbiAgICovXG4gIGNhbGwocmVjaXBpZW50LCBhbnN3ZXJVcmwsIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFhbnN3ZXJVcmwpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLmFuc3dlclVybCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIW9wdHMpIHtcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcImFuc3dlcl91cmxcIl0gPSBhbnN3ZXJVcmw7XG4gICAgICB0aGlzLl9zZW5kVm9pY2VNZXNzYWdlKFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLnJlc3RIb3N0IHx8IFwicmVzdC5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBcIi9jYWxsL2pzb25cIixcbiAgICAgICAgfSxcbiAgICAgICAgb3B0cyxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFZvaWNlO1xuIl19