"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Verify {
  static get PATH() {
    return "/verify{action}/json";
  }

  static get ERROR_MESSAGES() {
    return {
      verifyValidation: "Missing Mandatory fields (number and/or brand)",
      checkVerifyValidation: "Missing Mandatory fields (request_id and/or code)",
      controlVerifyValidation: "Missing Mandatory fields (request_id and/or cmd-command)",
      searchVerifyValidation: "Missing Mandatory fields (request_id or request_ids)"
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition Verify options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
  }
  /**
   * TODO: document
   */


  request(inputParams, callback) {
    if (!inputParams.number || !inputParams.brand) {
      _Utils.default.sendError(callback, new Error(Verify.ERROR_MESSAGES.verifyValidation));
    } else {
      inputParams["api_key"] = this.creds.apiKey;
      inputParams["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils.default.createPathWithQuery("".concat(Verify.PATH.replace("{action}", "")), inputParams)
      }, callback);
    }
  }
  /**
   * TODO: document
   */


  psd2(inputParams, callback) {
    inputParams["api_key"] = this.creds.apiKey;
    inputParams["api_secret"] = this.creds.apiSecret;
    this.options.httpClient.request({
      host: this.options.apiHost || "api.nexmo.com",
      path: _Utils.default.createPathWithQuery("".concat(Verify.PATH.replace("{action}", "/psd2")), inputParams)
    }, callback);
  }
  /**
   * TODO: document
   */


  check(inputParams, callback) {
    if (!inputParams.request_id || !inputParams.code) {
      _Utils.default.sendError(callback, new Error(Verify.ERROR_MESSAGES.checkVerifyValidation));
    } else {
      inputParams["api_key"] = this.creds.apiKey;
      inputParams["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils.default.createPathWithQuery("".concat(Verify.PATH.replace("{action}", "/check")), inputParams)
      }, callback);
    }
  }
  /**
   * TODO: document
   */


  control(inputParams, callback) {
    if (!inputParams.request_id || !inputParams.cmd) {
      _Utils.default.sendError(callback, new Error(Verify.ERROR_MESSAGES.controlVerifyValidation));
    } else {
      inputParams["api_key"] = this.creds.apiKey;
      inputParams["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils.default.createPathWithQuery("".concat(Verify.PATH.replace("{action}", "/control")), inputParams)
      }, callback);
    }
  }
  /**
   * TODO: document
   */


  search(requestIds, callback) {
    var requestIdParam = {};

    if (!requestIds) {
      _Utils.default.sendError(callback, new Error(Verify.ERROR_MESSAGES.searchVerifyValidation));
    } else {
      if (Array.isArray(requestIds)) {
        if (requestIds.length === 1) {
          requestIdParam.request_id = requestIds;
        } else {
          requestIdParam.request_ids = requestIds;
        }
      } else {
        requestIdParam.request_id = requestIds;
      }

      requestIdParam["api_key"] = this.creds.apiKey;
      requestIdParam["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils.default.createPathWithQuery("".concat(Verify.PATH.replace("{action}", "/search")), requestIdParam)
      }, callback);
    }
  }

}

var _default = Verify;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9WZXJpZnkuanMiXSwibmFtZXMiOlsiVmVyaWZ5IiwiUEFUSCIsIkVSUk9SX01FU1NBR0VTIiwidmVyaWZ5VmFsaWRhdGlvbiIsImNoZWNrVmVyaWZ5VmFsaWRhdGlvbiIsImNvbnRyb2xWZXJpZnlWYWxpZGF0aW9uIiwic2VhcmNoVmVyaWZ5VmFsaWRhdGlvbiIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJyZXF1ZXN0IiwiaW5wdXRQYXJhbXMiLCJjYWxsYmFjayIsIm51bWJlciIsImJyYW5kIiwiVXRpbHMiLCJzZW5kRXJyb3IiLCJFcnJvciIsImFwaUtleSIsImFwaVNlY3JldCIsImh0dHBDbGllbnQiLCJob3N0IiwiYXBpSG9zdCIsInBhdGgiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwicmVwbGFjZSIsInBzZDIiLCJjaGVjayIsInJlcXVlc3RfaWQiLCJjb2RlIiwiY29udHJvbCIsImNtZCIsInNlYXJjaCIsInJlcXVlc3RJZHMiLCJyZXF1ZXN0SWRQYXJhbSIsIkFycmF5IiwiaXNBcnJheSIsImxlbmd0aCIsInJlcXVlc3RfaWRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOzs7O0FBRUEsTUFBTUEsTUFBTixDQUFhO0FBQ0ksYUFBSkMsSUFBSSxHQUFHO0FBQ2hCLFdBQU8sc0JBQVA7QUFDRDs7QUFFd0IsYUFBZEMsY0FBYyxHQUFHO0FBQzFCLFdBQU87QUFDTEMsTUFBQUEsZ0JBQWdCLEVBQUUsZ0RBRGI7QUFFTEMsTUFBQUEscUJBQXFCLEVBQ25CLG1EQUhHO0FBSUxDLE1BQUFBLHVCQUF1QixFQUNyQiwwREFMRztBQU1MQyxNQUFBQSxzQkFBc0IsRUFDcEI7QUFQRyxLQUFQO0FBU0Q7QUFDRDtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQUNFQyxFQUFBQSxXQUFXLENBQUNDLFdBQUQsRUFBNEI7QUFBQSxRQUFkQyxPQUFjLHVFQUFKLEVBQUk7QUFDckMsU0FBS0MsS0FBTCxH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TU87QUFDTEMsUUFBQUEsY0FBYyxDQUFDTixVQUFmLEdBQTRCSyxVQUE1QjtBQUNEOztBQUNEQyxNQUFBQSxjQUFjLENBQUMsU0FBRCxDQUFkLEdBQTRCLEtBQUt6QixLQUFMLENBQVdTLE1BQXZDO0FBQ0FnQixNQUFBQSxjQUFjLENBQUMsWUFBRCxDQUFkLEdBQStCLEtBQUt6QixLQUFMLENBQVdVLFNBQTFDO0FBQ0EsV0FBS1gsT0FBTCxDQUFhWSxVQUFiLENBQXdCVixPQUF4QixDQUNFO0FBQ0VXLFFBQUFBLElBQUksRUFBRSxLQUFLYixPQUFMLENBQWFjLE9BQWIsSUFBd0IsZUFEaEM7QUFFRUMsUUFBQUEsSUFBSSxFQUFFUixlQUFNUyxtQkFBTixXQUNEekIsTUFBTSxDQUFDQyxJQUFQLENBQVl5QixPQUFaLENBQW9CLFVBQXBCLEVBQWdDLFNBQWhDLENBREMsR0FFSlMsY0FGSTtBQUZSLE9BREYsRUFRRXRCLFFBUkY7QUFVRDtBQUNGOztBQXpKVTs7ZUE0SkViLE0iLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL1V0aWxzXCI7XG5cbmNsYXNzIFZlcmlmeSB7XG4gIHN0YXRpYyBnZXQgUEFUSCgpIHtcbiAgICByZXR1cm4gXCIvdmVyaWZ5e2FjdGlvbn0vanNvblwiO1xuICB9XG5cbiAgc3RhdGljIGdldCBFUlJPUl9NRVNTQUdFUygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdmVyaWZ5VmFsaWRhdGlvbjogXCJNaXNzaW5nIE1hbmRhdG9yeSBmaWVsZHMgKG51bWJlciBhbmQvb3IgYnJhbmQpXCIsXG4gICAgICBjaGVja1ZlcmlmeVZhbGlkYXRpb246XG4gICAgICAgIFwiTWlzc2luZyBNYW5kYXRvcnkgZmllbGRzIChyZXF1ZXN0X2lkIGFuZC9vciBjb2RlKVwiLFxuICAgICAgY29udHJvbFZlcmlmeVZhbGlkYXRpb246XG4gICAgICAgIFwiTWlzc2luZyBNYW5kYXRvcnkgZmllbGRzIChyZXF1ZXN0X2lkIGFuZC9vciBjbWQtY29tbWFuZClcIixcbiAgICAgIHNlYXJjaFZlcmlmeVZhbGlkYXRpb246XG4gICAgICAgIFwiTWlzc2luZyBNYW5kYXRvcnkgZmllbGRzIChyZXF1ZXN0X2lkIG9yIHJlcXVlc3RfaWRzKVwiLFxuICAgIH07XG4gIH1cbiAgLyoqXG4gICAqIEBwYXJhbSB7Q3JlZGVudGlhbHN9IGNyZWRlbnRpYWxzXG4gICAqICAgIGNyZWRlbnRpYWxzIHRvIGJlIHVzZWQgd2hlbiBpbnRlcmFjdGluZyB3aXRoIHRoZSBBUEkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gICAqICAgIEFkZGl0aW9uIFZlcmlmeSBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoY3JlZGVudGlhbHMsIG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuY3JlZHMgPSBjcmVkZW50aWFscztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICByZXF1ZXN0KGlucHV0UGFyYW1zLCBjYWxsYmFjaykge1xuICAgIGlmICghaW5wdXRQYXJhbXMubnVtYmVyIHx8ICFpbnB1dFBhcmFtcy5icmFuZCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgbmV3IEVycm9yKFZlcmlmeS5FUlJPUl9NRVNTQUdFUy52ZXJpZnlWYWxpZGF0aW9uKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaW5wdXRQYXJhbXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkcy5hcGlLZXk7XG4gICAgICBpbnB1dFBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRzLmFwaVNlY3JldDtcbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KFxuICAgICAgICAgICAgYCR7VmVyaWZ5LlBBVEgucmVwbGFjZShcInthY3Rpb259XCIsIFwiXCIpfWAsXG4gICAgICAgICAgICBpbnB1dFBhcmFtc1xuICAgICAgICAgICksXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgcHNkMihpbnB1dFBhcmFtcywgY2FsbGJhY2spIHtcbiAgICBpbnB1dFBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRzLmFwaUtleTtcbiAgICBpbnB1dFBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRzLmFwaVNlY3JldDtcbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShcbiAgICAgICAgICBgJHtWZXJpZnkuUEFUSC5yZXBsYWNlKFwie2FjdGlvbn1cIiwgXCIvcHNkMlwiKX1gLFxuICAgICAgICAgIGlucHV0UGFyYW1zXG4gICAgICAgICksXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBjaGVjayhpbnB1dFBhcmFtcywgY2FsbGJhY2spIHtcbiAgICBpZiAoIWlucHV0UGFyYW1zLnJlcXVlc3RfaWQgfHwgIWlucHV0UGFyYW1zLmNvZGUpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIG5ldyBFcnJvcihWZXJpZnkuRVJST1JfTUVTU0FHRVMuY2hlY2tWZXJpZnlWYWxpZGF0aW9uKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaW5wdXRQYXJhbXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkcy5hcGlLZXk7XG4gICAgICBpbnB1dFBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRzLmFwaVNlY3JldDtcbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KFxuICAgICAgICAgICAgYCR7VmVyaWZ5LlBBVEgucmVwbGFjZShcInthY3Rpb259XCIsIFwiL2NoZWNrXCIpfWAsXG4gICAgICAgICAgICBpbnB1dFBhcmFtc1xuICAgICAgICAgICksXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgY29udHJvbChpbnB1dFBhcmFtcywgY2FsbGJhY2spIHtcbiAgICBpZiAoIWlucHV0UGFyYW1zLnJlcXVlc3RfaWQgfHwgIWlucHV0UGFyYW1zLmNtZCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgbmV3IEVycm9yKFZlcmlmeS5FUlJPUl9NRVNTQUdFUy5jb250cm9sVmVyaWZ5VmFsaWRhdGlvbilcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlucHV0UGFyYW1zW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZHMuYXBpS2V5O1xuICAgICAgaW5wdXRQYXJhbXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkcy5hcGlTZWNyZXQ7XG4gICAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShcbiAgICAgICAgICAgIGAke1ZlcmlmeS5QQVRILnJlcGxhY2UoXCJ7YWN0aW9ufVwiLCBcIi9jb250cm9sXCIpfWAsXG4gICAgICAgICAgICBpbnB1dFBhcmFtc1xuICAgICAgICAgICksXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VhcmNoKHJlcXVlc3RJZHMsIGNhbGxiYWNrKSB7XG4gICAgdmFyIHJlcXVlc3RJZFBhcmFtID0ge307XG4gICAgaWYgKCFyZXF1ZXN0SWRzKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICBuZXcgRXJyb3IoVmVyaWZ5LkVSUk9SX01FU1NBR0VTLnNlYXJjaFZlcmlmeVZhbGlkYXRpb24pXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXF1ZXN0SWRzKSkge1xuICAgICAgICBpZiAocmVxdWVzdElkcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICByZXF1ZXN0SWRQYXJhbS5yZXF1ZXN0X2lkID0gcmVxdWVzdElkcztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXF1ZXN0SWRQYXJhbS5yZXF1ZXN0X2lkcyA9IHJlcXVlc3RJZHM7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcXVlc3RJZFBhcmFtLnJlcXVlc3RfaWQgPSByZXF1ZXN0SWRzO1xuICAgICAgfVxuICAgICAgcmVxdWVzdElkUGFyYW1bXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkcy5hcGlLZXk7XG4gICAgICByZXF1ZXN0SWRQYXJhbVtcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRzLmFwaVNlY3JldDtcbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KFxuICAgICAgICAgICAgYCR7VmVyaWZ5LlBBVEgucmVwbGFjZShcInthY3Rpb259XCIsIFwiL3NlYXJjaFwiKX1gLFxuICAgICAgICAgICAgcmVxdWVzdElkUGFyYW1cbiAgICAgICAgICApLFxuICAgICAgICB9LFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVmVyaWZ5O1xuIl19