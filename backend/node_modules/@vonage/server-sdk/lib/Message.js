"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

var _ShortCode = _interopRequireDefault(require("./ShortCode"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var querystring = require("querystring");

class Message {
  static get ERROR_MESSAGES() {
    return {
      sender: "Invalid from address",
      to: "Invalid to address",
      msg: "Invalid Text Message",
      body: "Invalid Body value in Binary Message",
      udh: "Invalid udh value in Binary Message",
      title: "Invalid title in WAP Push message",
      url: "Invalid url in WAP Push message"
    };
  }

  static get PATH() {
    return "/sms/json";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition SMS options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;

    var _shortcode = new _ShortCode.default(this.creds, this.options);

    this.shortcodeAlert = _shortcode.shortcodeAlert.bind(_shortcode);
    this.shortcode2FA = _shortcode.shortcode2FA.bind(_shortcode);
    this.shortcodeMarketing = _shortcode.shortcodeMarketing.bind(_shortcode);
  }

  _sendRequest(endpoint, method, callback) {
    endpoint.path = endpoint.path + (endpoint.path.indexOf("?") > 0 ? "&" : "?") + querystring.stringify({
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    });
    this.options.httpClient.request(endpoint, method, callback);
  }

  _sendMessage(data, callback) {
    if (!data.from) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.sender));
    } else if (!data.to) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.to));
    } else {
      var path = Message.PATH + "?" + querystring.stringify(data);
      this.options.logger.info("sending message from " + data.from + " to " + data.to + " with message " + data.text);

      this._sendRequest({
        host: this.options.restHost || "rest.nexmo.com",
        path: path
      }, "POST", function (err, apiResponse) {
        if (!err && apiResponse.status && apiResponse.messages[0].status > 0) {
          _Utils.default.sendError(callback, new Error(apiResponse.messages[0]["error-text"]), apiResponse);
        } else {
          if (callback) callback(err, apiResponse);
        }
      });
    }
  }
  /**
   * TODO: document
   */


  sendSms(sender, recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.msg));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["text"] = message;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendBinaryMessage(sender, recipient, body, udh, opts, callback) {
    if (!body) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.body));
    } else if (!udh) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.udh));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "binary";
      opts["body"] = body;
      opts["udh"] = udh;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendWapPushMessage(sender, recipient, title, url, validity, opts, callback) {
    if (!title) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.title));
    } else if (!url) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.url));
    } else {
      if (typeof validity === "function") {
        callback = validity;
        opts = {};
        validity = 86400000;
      }

      if (typeof opts === "function") {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "wappush";
      opts["title"] = title;
      opts["validity"] = validity;
      opts["url"] = url;

      this._sendMessage(opts, callback);
    }
  }

  search(id, callback) {
    if (typeof id == "string") {
      return this.options.rest.get("/search/message", {
        id: id
      }, callback);
    } // Otherwise we expect an array


    return this.options.rest.get("/search/messages", {
      ids: id
    }, callback);
  }

  searchRejections(to, date, callback) {
    return this.options.rest.get("/search/rejections", {
      to,
      date
    }, callback);
  }

}

var _default = Message;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZXNzYWdlLmpzIl0sIm5hbWVzIjpbInF1ZXJ5c3RyaW5nIiwicmVxdWlyZSIsIk1lc3NhZ2UiLCJFUlJPUl9NRVNTQUdFUyIsInNlbmRlciIsInRvIiwibXNnIiwiYm9keSIsInVkaCIsInRpdGxlIiwidXJsIiwiUEFUSCIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfc2hvcnRjb2RlIiwiU2hvcnRDb2RlIiwic2hvcnRjb2RlQWxlcnQiLCJiaW5kIiwic2hvcnRjb2RlMkZBIiwic2hvcnRjb2RlTWFya2V0aW5nIiwiX3NlbmRSZXF1ZXN0IiwiZW5kcG9pbnQiLCJtZXRob2QiLCJjYWxsYmFjayIsInBhdGgiLCJpbmRleE9mIiwic3RyaW5naWZ5IiwiYXBpX2tleSIsImFwaUtleSIsImFwaV9zZWNyZXQiLCJhcGlTZWNyZXQiLCJodHRwQ2xpZW50IiwicmVxdWVzdCIsIl9zZW5kTWVzc2FnZSIsImRhdGEiLCJmcm9tIiwiVXRpbHMiLCJzZW5kRXJyb3IiLCJFcnJvciIsImxvZ2dlciIsImluZm8iLCJ0ZXh0IiwiaG9zdCIsInJlc3RIb3N0IiwiZXJyIiwiYXBpUmVzcG9uc2UiLCJzdGF0dXMiLCJtZXNzYWdlcyIsInNlbmRTbXMiLCJyZWNpcGllbnQiLCJtZXNzYWdlIiwib3B0cyIsInNlbmRCaW5hcnlNZXNzYWdlIiwic2VuZFdhcFB1c2hNZXNzYWdlIiwidmFsaWRpdHkiLCJzZWFyY2giLCJpZCIsInJlc3QiLCJnZXQiLCJpZHMiLCJzZWFyY2hSZWplY3Rpb25zIiwiZGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFFQTs7OztBQUVBLElBQUlBLFdBQVcsR0FBR0MsT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBRUEsTUFBTUMsT0FBTixDQUFjO0FBQ2EsYUFBZEMsY0FBYyxHQUFHO0FBQzFCLFdBQU87QUFDTEMsTUFBQUEsTUFBTSxFQUFFLHNCQURIO0FBRUxDLE1BQUFBLEVBQUUs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UUFMSyxDQUFQO0FBT0QsS0FUa0IsQ0FXbkI7OztBQUNBLFdBQU8sS0FBS1gsT0FBTCxDQUFhNkMsSUFBYixDQUFrQkMsR0FBbEIsQ0FDTCxrQkFESyxFQUVMO0FBQ0VDLE1BQUFBLEdBQUcsRUFBRUg7QUFEUCxLQUZLLEVBS0xqQyxRQUxLLENBQVA7QUFPRDs7QUFFRHFDLEVBQUFBLGdCQUFnQixDQUFDekQsRUFBRCxFQUFLMEQsSUFBTCxFQUFXdEMsUUFBWCxFQUFxQjtBQUNuQyxXQUFPLEtBQUtYLE9BQUwsQ0FBYTZDLElBQWIsQ0FBa0JDLEdBQWxCLENBQ0wsb0JBREssRUFFTDtBQUNFdkQsTUFBQUEsRUFERjtBQUVFMEQsTUFBQUE7QUFGRixLQUZLLEVBTUx0QyxRQU5LLENBQVA7QUFRRDs7QUF2TFc7O2VBMExDdkIsTyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuaW1wb3J0IFNob3J0Q29kZSBmcm9tIFwiLi9TaG9ydENvZGVcIjtcblxudmFyIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZShcInF1ZXJ5c3RyaW5nXCIpO1xuXG5jbGFzcyBNZXNzYWdlIHtcbiAgc3RhdGljIGdldCBFUlJPUl9NRVNTQUdFUygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc2VuZGVyOiBcIkludmFsaWQgZnJvbSBhZGRyZXNzXCIsXG4gICAgICB0bzogXCJJbnZhbGlkIHRvIGFkZHJlc3NcIixcbiAgICAgIG1zZzogXCJJbnZhbGlkIFRleHQgTWVzc2FnZVwiLFxuICAgICAgYm9keTogXCJJbnZhbGlkIEJvZHkgdmFsdWUgaW4gQmluYXJ5IE1lc3NhZ2VcIixcbiAgICAgIHVkaDogXCJJbnZhbGlkIHVkaCB2YWx1ZSBpbiBCaW5hcnkgTWVzc2FnZVwiLFxuICAgICAgdGl0bGU6IFwiSW52YWxpZCB0aXRsZSBpbiBXQVAgUHVzaCBtZXNzYWdlXCIsXG4gICAgICB1cmw6IFwiSW52YWxpZCB1cmwgaW4gV0FQIFB1c2ggbWVzc2FnZVwiLFxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgZ2V0IFBBVEgoKSB7XG4gICAgcmV0dXJuIFwiL3Ntcy9qc29uXCI7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHNcbiAgICogICAgY3JlZGVudGlhbHMgdG8gYmUgdXNlZCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIEFQSS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAgICogICAgQWRkaXRpb24gU01TIG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICB2YXIgX3Nob3J0Y29kZSA9IG5ldyBTaG9ydENvZGUodGhpcy5jcmVkcywgdGhpcy5vcHRpb25zKTtcblxuICAgIHRoaXMuc2hvcnRjb2RlQWxlcnQgPSBfc2hvcnRjb2RlLnNob3J0Y29kZUFsZXJ0LmJpbmQoX3Nob3J0Y29kZSk7XG4gICAgdGhpcy5zaG9ydGNvZGUyRkEgPSBfc2hvcnRjb2RlLnNob3J0Y29kZTJGQS5iaW5kKF9zaG9ydGNvZGUpO1xuICAgIHRoaXMuc2hvcnRjb2RlTWFya2V0aW5nID0gX3Nob3J0Y29kZS5zaG9ydGNvZGVNYXJrZXRpbmcuYmluZChfc2hvcnRjb2RlKTtcbiAgfVxuXG4gIF9zZW5kUmVxdWVzdChlbmRwb2ludCwgbWV0aG9kLCBjYWxsYmFjaykge1xuICAgIGVuZHBvaW50LnBhdGggPVxuICAgICAgZW5kcG9pbnQucGF0aCArXG4gICAgICAoZW5kcG9pbnQucGF0aC5pbmRleE9mKFwiP1wiKSA+IDAgPyBcIiZcIiA6IFwiP1wiKSArXG4gICAgICBxdWVyeXN0cmluZy5zdHJpbmdpZnkoe1xuICAgICAgICBhcGlfa2V5OiB0aGlzLmNyZWRzLmFwaUtleSxcbiAgICAgICAgYXBpX3NlY3JldDogdGhpcy5jcmVkcy5hcGlTZWNyZXQsXG4gICAgICB9KTtcbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KGVuZHBvaW50LCBtZXRob2QsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIF9zZW5kTWVzc2FnZShkYXRhLCBjYWxsYmFjaykge1xuICAgIGlmICghZGF0YS5mcm9tKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLnNlbmRlcikpO1xuICAgIH0gZWxzZSBpZiAoIWRhdGEudG8pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudG8pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIHBhdGggPSBNZXNzYWdlLlBBVEggKyBcIj9cIiArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShkYXRhKTtcbiAgICAgIHRoaXMub3B0aW9ucy5sb2dnZXIuaW5mbyhcbiAgICAgICAgXCJzZW5kaW5nIG1lc3NhZ2UgZnJvbSBcIiArXG4gICAgICAgICAgZGF0YS5mcm9tICtcbiAgICAgICAgICBcIiB0byBcIiArXG4gICAgICAgICAgZGF0YS50byArXG4gICAgICAgICAgXCIgd2l0aCBtZXNzYWdlIFwiICtcbiAgICAgICAgICBkYXRhLnRleHRcbiAgICAgICk7XG4gICAgICB0aGlzLl9zZW5kUmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5yZXN0SG9zdCB8fCBcInJlc3QubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgfSxcbiAgICAgICAgXCJQT1NUXCIsXG4gICAgICAgIGZ1bmN0aW9uIChlcnIsIGFwaVJlc3BvbnNlKSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgIWVyciAmJlxuICAgICAgICAgICAgYXBpUmVzcG9uc2Uuc3RhdHVzICYmXG4gICAgICAgICAgICBhcGlSZXNwb25zZS5tZXNzYWdlc1swXS5zdGF0dXMgPiAwXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBVdGlscy5zZW5kRXJyb3IoXG4gICAgICAgICAgICAgIGNhbGxiYWNrLFxuICAgICAgICAgICAgICBuZXcgRXJyb3IoYXBpUmVzcG9uc2UubWVzc2FnZXNbMF1bXCJlcnJvci10ZXh0XCJdKSxcbiAgICAgICAgICAgICAgYXBpUmVzcG9uc2VcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soZXJyLCBhcGlSZXNwb25zZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZFNtcyhzZW5kZXIsIHJlY2lwaWVudCwgbWVzc2FnZSwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMubXNnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sgPSBvcHRzO1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1wiZnJvbVwiXSA9IHNlbmRlcjtcbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0ZXh0XCJdID0gbWVzc2FnZTtcbiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKG9wdHMsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlbmRCaW5hcnlNZXNzYWdlKHNlbmRlciwgcmVjaXBpZW50LCBib2R5LCB1ZGgsIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFib2R5KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLmJvZHkpKTtcbiAgICB9IGVsc2UgaWYgKCF1ZGgpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudWRoKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghY2FsbGJhY2spIHtcbiAgICAgICAgY2FsbGJhY2sgPSBvcHRzO1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1wiZnJvbVwiXSA9IHNlbmRlcjtcbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0eXBlXCJdID0gXCJiaW5hcnlcIjtcbiAgICAgIG9wdHNbXCJib2R5XCJdID0gYm9keTtcbiAgICAgIG9wdHNbXCJ1ZGhcIl0gPSB1ZGg7XG4gICAgICB0aGlzLl9zZW5kTWVzc2FnZShvcHRzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZW5kV2FwUHVzaE1lc3NhZ2Uoc2VuZGVyLCByZWNpcGllbnQsIHRpdGxlLCB1cmwsIHZhbGlkaXR5LCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghdGl0bGUpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudGl0bGUpKTtcbiAgICB9IGVsc2UgaWYgKCF1cmwpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMudXJsKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0eXBlb2YgdmFsaWRpdHkgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IHZhbGlkaXR5O1xuICAgICAgICBvcHRzID0ge307XG4gICAgICAgIHZhbGlkaXR5ID0gODY0MDAwMDA7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIG9wdHMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInR5cGVcIl0gPSBcIndhcHB1c2hcIjtcbiAgICAgIG9wdHNbXCJ0aXRsZVwiXSA9IHRpdGxlO1xuICAgICAgb3B0c1tcInZhbGlkaXR5XCJdID0gdmFsaWRpdHk7XG4gICAgICBvcHRzW1widXJsXCJdID0gdXJsO1xuICAgICAgdGhpcy5fc2VuZE1lc3NhZ2Uob3B0cywgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIHNlYXJjaChpZCwgY2FsbGJhY2spIHtcbiAgICBpZiAodHlwZW9mIGlkID09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMucmVzdC5nZXQoXG4gICAgICAgIFwiL3NlYXJjaC9tZXNzYWdlXCIsXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogaWQsXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIE90aGVyd2lzZSB3ZSBleHBlY3QgYW4gYXJyYXlcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLnJlc3QuZ2V0KFxuICAgICAgXCIvc2VhcmNoL21lc3NhZ2VzXCIsXG4gICAgICB7XG4gICAgICAgIGlkczogaWQsXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgc2VhcmNoUmVqZWN0aW9ucyh0bywgZGF0ZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLnJlc3QuZ2V0KFxuICAgICAgXCIvc2VhcmNoL3JlamVjdGlvbnNcIixcbiAgICAgIHtcbiAgICAgICAgdG8sXG4gICAgICAgIGRhdGUsXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IE1lc3NhZ2U7XG4iXX0=