"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class NumberInsight {
  static get PATH() {
    return "/ni/{type}/json";
  }

  static get ERROR_MESSAGES() {
    return {
      numberInsightAdvancedValidation: "Missing Mandatory fields (number and/or callback url)",
      numberInsightValidation: "Missing Mandatory field - number",
      numberInsightPatternFailure: "Number can contain digits and may include any or all of the following: white space, -,+, (, )."
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition NumberInsight options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
  }
  /**
   * Get insight on the provided number.
   *
   * @param {Object} options - The options for Number Insight
   * @param {string} options.level - the level of insight: 'basic', 'standard'
   *                 or 'advanced'.
   *                 If no `level` value is provided, or an unrecognised value
   *                 is used, 'basic' level insight will be used.
   * @param {string} options.number - the phone number to retrieve insight on
   * @param {string} options.country - 'basic' and 'standard' only.
   *                 An ISO 3166 Alpha 2 country code
   *                 https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2
   * @param {string} options. ip - 'advanced' only.
   *                 The IP address in IPv4 notation of the endpoint the
   *                 user connected from.
   * @param {Array}  options.features - 'advanced' only.
   *                 An Array detailing the information you want for this phone
   *                 number. Possible Array elements are:
   *                 - type: number is one of the following: mobile, landline,
   *                          landline_premium or unknown phone number.
   *                 - valid: number exists.
   *                 - reachable: is number available now.
   *                 - carrier: the MCCMNC for the carrier number is registered
   *                             with. This is either: <ISO country code>-FIXED
   *                             or <ISO country code>-PREMIUM.
   *                 - ported: if the user has changed carrier for number.
   *                 - roaming: the subscriber is outside their home network
   *
   * @param {string} options.callback - 'advanced' only.
   *                 The callback to be called when the API call completes.
   * @param {Number} options.callback_timeout - 'advanced' only.
   *                 The maximum wait until the Number Insight Return Parameters
   *                 are sent to callback. This is a value between 1000 - 30000ms
   *                 inclusive. The default is 30000 ms.
   * @param {string} options.callback_method - 'advanced' only.
   *                 The HTTP method used to send the Number Insight Return
   *                 Parameters to callback. Must be GET or POST. The default
   *                 value is GET.
   * @param {string} options.client_ref - 'advanced' only.
   *                 A 40 character reference string returned in the Number
   *                 Insight Return Parameters. This may be useful for your
   *                 internal reports.
   * @param {string} options['include-intermediate-callbacks'] - 'advanced' only.
   *                 Tells the Vonage platform to make callbacks as soon as an
   *                 individual piece of information is retrieved.
   */


  get(options, callback) {
    var level = options.level; // remove 'level' as it's a library-only parameter

    delete options.level;

    if (level === "advanced" || level === "advancedAsync") {
      if (level === "advanced") {
        console.warn('DEPRECATION WARNING: Number Insight Advanced with a level of "advanced" will be synchronous in v2.0+. Consider using the level "advancedAsync" to keep using the async option.');
      }

      this._numberInsightAsync(options, callback);
    } else if (level === "advancedSync") {
      this._numberInsightCommon("advanced", options, callback);
    } else if (level === "standard") {
      this._numberInsightCommon("standard", options, callback);
    } else {
      this._numberInsightCommon("basic", options, callback);
    }
  }

  _numberInsightAsync(inputParams, callback) {
    if (!inputParams.number || !inputParams.callback) {
      _Utils.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightAdvancedValidation));
    } else {
      inputParams["api_key"] = this.creds.apiKey;
      inputParams["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils.default.createPathWithQuery("".concat(NumberInsight.PATH.replace("{type}", "advanced/async")), inputParams)
      }, callback);
    }
  }

  _numberInsightCommon(type, inputParams, callback) {
    if (this._validateNumber(inputParams, callback)) {
      var inputObj;

      if (typeof inputParams !== "object") {
        inputObj = {
          number: inputParams
        };
      } else {
        inputObj = inputParams;
      }

      inputObj["api_key"] = this.creds.apiKey;
      inputObj["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        host: this.options.apiHost || "api.nexmo.com",
        path: _Utils.default.createPathWithQuery("".concat(NumberInsight.PATH.replace("{type}", type)), inputObj)
      }, callback);
    }
  }

  _validateNumber(inputParams, callback) {
    var numberPattern = new RegExp("^[0-9 +()-]*$");

    if (typeof inputParams === "object" && !inputParams.number) {
      _Utils.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightValidation));
    } else if (typeof inputParams === "object" && !numberPattern.test(inputParams.number)) {
      _Utils.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightPatternFailure));
    } else if (typeof inputParams !== "object" && (!inputParams || !numberPattern.test(inputParams))) {
      _Utils.default.sendError(callback, new Error(NumberInsight.ERROR_MESSAGES.numberInsightPatternFailure));
    }

    return true;
  }

}

var _default = NumberInsight;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9OdW1iZXJJbnNpZ2h0LmpzIl0sIm5hbWVzIjpbIk51bWJlckluc2lnaHQiLCJQQVRIIiwiRVJST1JfTUVTU0FHRVMiLCJudW1iZXJJbnNpZ2h0QWR2YW5jZWRWYWxpZGF0aW9uIiwibnVtYmVySW5zaWdodFZhbGlkYXRpb24iLCJudW1iZXJJbnNpZ2h0UGF0dGVybkZhaWx1cmUiLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiZ2V0IiwiY2FsbGJhY2siLCJsZXZlbCIsImNvbnNvbGUiLCJ3YXJuIiwiX251bWJlckluc2lnaHRBc3luYyIsIl9udW1iZXJJbnNpZ2h0Q29tbW9uIiwiaW5wdXRQYXJhbXMiLCJudW1iZXIiLCJVdGlscyIsInNlbmRFcnJvciIsIkVycm9yIiwiYXBpS2V5IiwiYXBpU2VjcmV0IiwiaHR0cENsaWVudCIsInJlcXVlc3QiLCJob3N0IiwiYXBpSG9zdCIsInBhdGgiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwicmVwbGFjZSIsInR5cGUiLCJfdmFsaWRhdGVOdW1iZXIiLCJpbnB1dE9iaiIsIm51bWJlclBhdHRlcm4iLCJSZWdFeHAiLCJ0ZXN0Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOzs7O0FBRUEsTUFBTUEsYUFBTixDQUFvQjtBQUNILGFBQUpDLElBQUksR0FBRztBQUNoQixXQUFPLGlCQUFQO0FBQ0Q7O0FBRXdCLGFBQWRDLGNBQWMsR0FBRztBQUMxQixXQUFPO0FBQ0xDLE1BQUFBLCtCQUErQixFQUM3Qix1REFGRztBQUdMQyxNQUFBQSx1QkFBdUIsRUFBRSxrQ0FIcEI7QUFJTEMsTUFBQUEsMkJBQTJCLEVBQ3pCO0FBTEcsS0FBUDtBQU9EO0FBQ0Q7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDRUMsRUFBQUEsV0FBVyxDQUFDQyxXQUFELEVBQTRCO0FBQUEsUUFBZEMsT0FBYyx1RUFBSixFQUFJO0FBQ3JDLFNBQUtDLEtBQUwsR0FBYUYsV0FBYjtBQUNB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LENBQVVyQixhQUFhLENBQUNFLGNBQWQsQ0FBNkJHLDJCQUF2QyxDQUZGO0FBSUQ7O0FBQ0QsV0FBTyxJQUFQO0FBQ0Q7O0FBcktpQjs7ZUF3S0xMLGEiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL1V0aWxzXCI7XG5cbmNsYXNzIE51bWJlckluc2lnaHQge1xuICBzdGF0aWMgZ2V0IFBBVEgoKSB7XG4gICAgcmV0dXJuIFwiL25pL3t0eXBlfS9qc29uXCI7XG4gIH1cblxuICBzdGF0aWMgZ2V0IEVSUk9SX01FU1NBR0VTKCkge1xuICAgIHJldHVybiB7XG4gICAgICBudW1iZXJJbnNpZ2h0QWR2YW5jZWRWYWxpZGF0aW9uOlxuICAgICAgICBcIk1pc3NpbmcgTWFuZGF0b3J5IGZpZWxkcyAobnVtYmVyIGFuZC9vciBjYWxsYmFjayB1cmwpXCIsXG4gICAgICBudW1iZXJJbnNpZ2h0VmFsaWRhdGlvbjogXCJNaXNzaW5nIE1hbmRhdG9yeSBmaWVsZCAtIG51bWJlclwiLFxuICAgICAgbnVtYmVySW5zaWdodFBhdHRlcm5GYWlsdXJlOlxuICAgICAgICBcIk51bWJlciBjYW4gY29udGFpbiBkaWdpdHMgYW5kIG1heSBpbmNsdWRlIGFueSBvciBhbGwgb2YgdGhlIGZvbGxvd2luZzogd2hpdGUgc3BhY2UsIC0sKywgKCwgKS5cIixcbiAgICB9O1xuICB9XG4gIC8qKlxuICAgKiBAcGFyYW0ge0NyZWRlbnRpYWxzfSBjcmVkZW50aWFsc1xuICAgKiAgICBjcmVkZW50aWFscyB0byBiZSB1c2VkIHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgQVBJLlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiAgICBBZGRpdGlvbiBOdW1iZXJJbnNpZ2h0IG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGluc2lnaHQgb24gdGhlIHByb3ZpZGVkIG51bWJlci5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgb3B0aW9ucyBmb3IgTnVtYmVyIEluc2lnaHRcbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnMubGV2ZWwgLSB0aGUgbGV2ZWwgb2YgaW5zaWdodDogJ2Jhc2ljJywgJ3N0YW5kYXJkJ1xuICAgKiAgICAgICAgICAgICAgICAgb3IgJ2FkdmFuY2VkJy5cbiAgICogICAgICAgICAgICAgICAgIElmIG5vIGBsZXZlbGAgdmFsdWUgaXMgcHJvdmlkZWQsIG9yIGFuIHVucmVjb2duaXNlZCB2YWx1ZVxuICAgKiAgICAgICAgICAgICAgICAgaXMgdXNlZCwgJ2Jhc2ljJyBsZXZlbCBpbnNpZ2h0IHdpbGwgYmUgdXNlZC5cbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnMubnVtYmVyIC0gdGhlIHBob25lIG51bWJlciB0byByZXRyaWV2ZSBpbnNpZ2h0IG9uXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmNvdW50cnkgLSAnYmFzaWMnIGFuZCAnc3RhbmRhcmQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBBbiBJU08gMzE2NiBBbHBoYSAyIGNvdW50cnkgY29kZVxuICAgKiAgICAgICAgICAgICAgICAgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSVNPXzMxNjYtMV9hbHBoYS0yXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLiBpcCAtICdhZHZhbmNlZCcgb25seS5cbiAgICogICAgICAgICAgICAgICAgIFRoZSBJUCBhZGRyZXNzIGluIElQdjQgbm90YXRpb24gb2YgdGhlIGVuZHBvaW50IHRoZVxuICAgKiAgICAgICAgICAgICAgICAgdXNlciBjb25uZWN0ZWQgZnJvbS5cbiAgICogQHBhcmFtIHtBcnJheX0gIG9wdGlvbnMuZmVhdHVyZXMgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBBbiBBcnJheSBkZXRhaWxpbmcgdGhlIGluZm9ybWF0aW9uIHlvdSB3YW50IGZvciB0aGlzIHBob25lXG4gICAqICAgICAgICAgICAgICAgICBudW1iZXIuIFBvc3NpYmxlIEFycmF5IGVsZW1lbnRzIGFyZTpcbiAgICogICAgICAgICAgICAgICAgIC0gdHlwZTogbnVtYmVyIGlzIG9uZSBvZiB0aGUgZm9sbG93aW5nOiBtb2JpbGUsIGxhbmRsaW5lLFxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgbGFuZGxpbmVfcHJlbWl1bSBvciB1bmtub3duIHBob25lIG51bWJlci5cbiAgICogICAgICAgICAgICAgICAgIC0gdmFsaWQ6IG51bWJlciBleGlzdHMuXG4gICAqICAgICAgICAgICAgICAgICAtIHJlYWNoYWJsZTogaXMgbnVtYmVyIGF2YWlsYWJsZSBub3cuXG4gICAqICAgICAgICAgICAgICAgICAtIGNhcnJpZXI6IHRoZSBNQ0NNTkMgZm9yIHRoZSBjYXJyaWVyIG51bWJlciBpcyByZWdpc3RlcmVkXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoLiBUaGlzIGlzIGVpdGhlcjogPElTTyBjb3VudHJ5IGNvZGU+LUZJWEVEXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciA8SVNPIGNvdW50cnkgY29kZT4tUFJFTUlVTS5cbiAgICogICAgICAgICAgICAgICAgIC0gcG9ydGVkOiBpZiB0aGUgdXNlciBoYXMgY2hhbmdlZCBjYXJyaWVyIGZvciBudW1iZXIuXG4gICAqICAgICAgICAgICAgICAgICAtIHJvYW1pbmc6IHRoZSBzdWJzY3JpYmVyIGlzIG91dHNpZGUgdGhlaXIgaG9tZSBuZXR3b3JrXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmNhbGxiYWNrIC0gJ2FkdmFuY2VkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgVGhlIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBBUEkgY2FsbCBjb21wbGV0ZXMuXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBvcHRpb25zLmNhbGxiYWNrX3RpbWVvdXQgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBUaGUgbWF4aW11bSB3YWl0IHVudGlsIHRoZSBOdW1iZXIgSW5zaWdodCBSZXR1cm4gUGFyYW1ldGVyc1xuICAgKiAgICAgICAgICAgICAgICAgYXJlIHNlbnQgdG8gY2FsbGJhY2suIFRoaXMgaXMgYSB2YWx1ZSBiZXR3ZWVuIDEwMDAgLSAzMDAwMG1zXG4gICAqICAgICAgICAgICAgICAgICBpbmNsdXNpdmUuIFRoZSBkZWZhdWx0IGlzIDMwMDAwIG1zLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy5jYWxsYmFja19tZXRob2QgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBUaGUgSFRUUCBtZXRob2QgdXNlZCB0byBzZW5kIHRoZSBOdW1iZXIgSW5zaWdodCBSZXR1cm5cbiAgICogICAgICAgICAgICAgICAgIFBhcmFtZXRlcnMgdG8gY2FsbGJhY2suIE11c3QgYmUgR0VUIG9yIFBPU1QuIFRoZSBkZWZhdWx0XG4gICAqICAgICAgICAgICAgICAgICB2YWx1ZSBpcyBHRVQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmNsaWVudF9yZWYgLSAnYWR2YW5jZWQnIG9ubHkuXG4gICAqICAgICAgICAgICAgICAgICBBIDQwIGNoYXJhY3RlciByZWZlcmVuY2Ugc3RyaW5nIHJldHVybmVkIGluIHRoZSBOdW1iZXJcbiAgICogICAgICAgICAgICAgICAgIEluc2lnaHQgUmV0dXJuIFBhcmFtZXRlcnMuIFRoaXMgbWF5IGJlIHVzZWZ1bCBmb3IgeW91clxuICAgKiAgICAgICAgICAgICAgICAgaW50ZXJuYWwgcmVwb3J0cy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IG9wdGlvbnNbJ2luY2x1ZGUtaW50ZXJtZWRpYXRlLWNhbGxiYWNrcyddIC0gJ2FkdmFuY2VkJyBvbmx5LlxuICAgKiAgICAgICAgICAgICAgICAgVGVsbHMgdGhlIFZvbmFnZSBwbGF0Zm9ybSB0byBtYWtlIGNhbGxiYWNrcyBhcyBzb29uIGFzIGFuXG4gICAqICAgICAgICAgICAgICAgICBpbmRpdmlkdWFsIHBpZWNlIG9mIGluZm9ybWF0aW9uIGlzIHJldHJpZXZlZC5cbiAgICovXG4gIGdldChvcHRpb25zLCBjYWxsYmFjaykge1xuICAgIHZhciBsZXZlbCA9IG9wdGlvbnMubGV2ZWw7XG4gICAgLy8gcmVtb3ZlICdsZXZlbCcgYXMgaXQncyBhIGxpYnJhcnktb25seSBwYXJhbWV0ZXJcbiAgICBkZWxldGUgb3B0aW9ucy5sZXZlbDtcblxuICAgIGlmIChsZXZlbCA9PT0gXCJhZHZhbmNlZFwiIHx8IGxldmVsID09PSBcImFkdmFuY2VkQXN5bmNcIikge1xuICAgICAgaWYgKGxldmVsID09PSBcImFkdmFuY2VkXCIpIHtcbiAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgICdERVBSRUNBVElPTiBXQVJOSU5HOiBOdW1iZXIgSW5zaWdodCBBZHZhbmNlZCB3aXRoIGEgbGV2ZWwgb2YgXCJhZHZhbmNlZFwiIHdpbGwgYmUgc3luY2hyb25vdXMgaW4gdjIuMCsuIENvbnNpZGVyIHVzaW5nIHRoZSBsZXZlbCBcImFkdmFuY2VkQXN5bmNcIiB0byBrZWVwIHVzaW5nIHRoZSBhc3luYyBvcHRpb24uJ1xuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5fbnVtYmVySW5zaWdodEFzeW5jKG9wdGlvbnMsIGNhbGxiYWNrKTtcbiAgICB9IGVsc2UgaWYgKGxldmVsID09PSBcImFkdmFuY2VkU3luY1wiKSB7XG4gICAgICB0aGlzLl9udW1iZXJJbnNpZ2h0Q29tbW9uKFwiYWR2YW5jZWRcIiwgb3B0aW9ucywgY2FsbGJhY2spO1xuICAgIH0gZWxzZSBpZiAobGV2ZWwgPT09IFwic3RhbmRhcmRcIikge1xuICAgICAgdGhpcy5fbnVtYmVySW5zaWdodENvbW1vbihcInN0YW5kYXJkXCIsIG9wdGlvbnMsIGNhbGxiYWNrKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbnVtYmVySW5zaWdodENvbW1vbihcImJhc2ljXCIsIG9wdGlvbnMsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICBfbnVtYmVySW5zaWdodEFzeW5jKGlucHV0UGFyYW1zLCBjYWxsYmFjaykge1xuICAgIGlmICghaW5wdXRQYXJhbXMubnVtYmVyIHx8ICFpbnB1dFBhcmFtcy5jYWxsYmFjaykge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgbmV3IEVycm9yKE51bWJlckluc2lnaHQuRVJST1JfTUVTU0FHRVMubnVtYmVySW5zaWdodEFkdmFuY2VkVmFsaWRhdGlvbilcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlucHV0UGFyYW1zW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZHMuYXBpS2V5O1xuICAgICAgaW5wdXRQYXJhbXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkcy5hcGlTZWNyZXQ7XG4gICAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAgICB7XG4gICAgICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShcbiAgICAgICAgICAgIGAke051bWJlckluc2lnaHQuUEFUSC5yZXBsYWNlKFwie3R5cGV9XCIsIFwiYWR2YW5jZWQvYXN5bmNcIil9YCxcbiAgICAgICAgICAgIGlucHV0UGFyYW1zXG4gICAgICAgICAgKSxcbiAgICAgICAgfSxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgX251bWJlckluc2lnaHRDb21tb24odHlwZSwgaW5wdXRQYXJhbXMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKHRoaXMuX3ZhbGlkYXRlTnVtYmVyKGlucHV0UGFyYW1zLCBjYWxsYmFjaykpIHtcbiAgICAgIHZhciBpbnB1dE9iajtcbiAgICAgIGlmICh0eXBlb2YgaW5wdXRQYXJhbXMgIT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgaW5wdXRPYmogPSB7XG4gICAgICAgICAgbnVtYmVyOiBpbnB1dFBhcmFtcyxcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlucHV0T2JqID0gaW5wdXRQYXJhbXM7XG4gICAgICB9XG4gICAgICBpbnB1dE9ialtcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRzLmFwaUtleTtcbiAgICAgIGlucHV0T2JqW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZHMuYXBpU2VjcmV0O1xuICAgICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgICAgIHBhdGg6IFV0aWxzLmNyZWF0ZVBhdGhXaXRoUXVlcnkoXG4gICAgICAgICAgICBgJHtOdW1iZXJJbnNpZ2h0LlBBVEgucmVwbGFjZShcInt0eXBlfVwiLCB0eXBlKX1gLFxuICAgICAgICAgICAgaW5wdXRPYmpcbiAgICAgICAgICApLFxuICAgICAgICB9LFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBfdmFsaWRhdGVOdW1iZXIoaW5wdXRQYXJhbXMsIGNhbGxiYWNrKSB7XG4gICAgdmFyIG51bWJlclBhdHRlcm4gPSBuZXcgUmVnRXhwKFwiXlswLTkgKygpLV0qJFwiKTtcblxuICAgIGlmICh0eXBlb2YgaW5wdXRQYXJhbXMgPT09IFwib2JqZWN0XCIgJiYgIWlucHV0UGFyYW1zLm51bWJlcikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgbmV3IEVycm9yKE51bWJlckluc2lnaHQuRVJST1JfTUVTU0FHRVMubnVtYmVySW5zaWdodFZhbGlkYXRpb24pXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICB0eXBlb2YgaW5wdXRQYXJhbXMgPT09IFwib2JqZWN0XCIgJiZcbiAgICAgICFudW1iZXJQYXR0ZXJuLnRlc3QoaW5wdXRQYXJhbXMubnVtYmVyKVxuICAgICkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgbmV3IEVycm9yKE51bWJlckluc2lnaHQuRVJST1JfTUVTU0FHRVMubnVtYmVySW5zaWdodFBhdHRlcm5GYWlsdXJlKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgdHlwZW9mIGlucHV0UGFyYW1zICE9PSBcIm9iamVjdFwiICYmXG4gICAgICAoIWlucHV0UGFyYW1zIHx8ICFudW1iZXJQYXR0ZXJuLnRlc3QoaW5wdXRQYXJhbXMpKVxuICAgICkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgbmV3IEVycm9yKE51bWJlckluc2lnaHQuRVJST1JfTUVTU0FHRVMubnVtYmVySW5zaWdodFBhdHRlcm5GYWlsdXJlKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTnVtYmVySW5zaWdodDtcbiJdfQ==